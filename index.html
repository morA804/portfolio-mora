<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mora – CVX | CV Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import all necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment (Assume these are defined in your specific execution context)
        // **NOTE:** Since this is a standalone HTML, these variables will be undefined, but the anonymous sign-in fallback handles it.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-mora-cvx';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Function to initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                if (!firebaseConfig) {
                    console.warn("Firebase configuration is missing. Initializing with fallback anonymous auth.");
                    // Fallback configuration (using a placeholder)
                    const placeholderConfig = {
                        apiKey: "AIzaSyC_PLACEHOLDER", // Must be a valid format, but functional doesn't matter here
                        authDomain: "placeholder.firebaseapp.com",
                        projectId: "placeholder-project"
                    };
                    app = initializeApp(placeholderConfig, appId);
                } else {
                    app = initializeApp(firebaseConfig, appId);
                }
                
                db = getFirestore(app);
                auth = getAuth(app);

                // Expose Firestore functions globally
                window.firebaseImports = {
                    doc: doc, setDoc: setDoc, getDoc: getDoc, onSnapshot: onSnapshot
                };

                const authPromise = new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                            console.log("Firebase Auth Ready. User ID:", userId);
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        // Unsubscribe after the first state change check
                        unsubscribe(); 
                        resolve();
                    });
                });

                await authPromise;
                // Only call setFirebaseReady once authentication is complete
                if (window.moraCVX && window.moraCVX.setFirebaseReady) {
                    window.moraCVX.setFirebaseReady(db, auth, userId);
                }
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
            }
        }

        // Expose function for the app
        window.initializeFirebase = initializeFirebase;

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* Custom Styles for Futuristic/Glassmorphism Design */
        :root {
            --primary-color: #6366f1; /* Indigo 500 */
            --bg-color: #0b0f1a;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            /* Glowing background effect */
            background-image: radial-gradient(at 0% 0%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                                  radial-gradient(at 100% 100%, rgba(34, 197, 94, 0.15) 0%, transparent 50%);
            min-height: 100vh;
            color: #e5e7eb; /* Light gray text */
            overflow-x: hidden;
        }

        /* Glassmorphism Card Style - Professional, floating appearance */
        .glass-card {
            background-color: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            /* Subtle blue glow/3D shadow */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1), 0 10px 15px -3px rgba(99, 102, 241, 0.15); 
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            /* Enhanced glow on hover */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.2), 0 20px 25px -5px rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }

        /* Futuristic Button Style - Gradient and shadow for a 3D effect */
        .futuristic-btn {
            @apply px-6 py-3 rounded-xl font-bold text-white shadow-lg transition-all duration-300 ease-in-out;
            background-image: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .futuristic-btn:hover {
            /* Stronger glow */
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.7);
            transform: scale(1.02);
        }
        .futuristic-btn:active {
            transform: scale(0.98);
        }
        
        /* 3D text effect for title and developer name (Glowing/Ethereal text) */
        .dev-text-3d {
            text-shadow: 
                0 0 8px rgba(99, 102, 241, 0.8), /* Inner glow */
                0 4px 8px rgba(0, 0, 0, 0.5); /* 3D depth */
            letter-spacing: 2px;
        }
        
        /* Signature/Logo Animation - Cinematic Write-on Effect (Mora - CVX) */
        #signature-text {
            /* Initial state for the animation */
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: 
                write-on 1.5s ease-out forwards, /* 1.5s for writing */
                text-glow 1.5s ease-in-out infinite alternate 1.5s; /* start glowing after writing */
            fill: #fff;
            stroke: var(--primary-color);
            stroke-width: 1;
        }
        /* Custom animation for write-on effect */
        @keyframes write-on {
            to {
                stroke-dashoffset: 0;
            }
        }

        @keyframes text-glow {
            from {
                text-shadow: 0 0 5px rgba(99, 102, 241, 0.4);
            }
            to {
                text-shadow: 0 0 20px rgba(99, 102, 241, 1), 0 0 30px rgba(139, 92, 246, 0.8);
            }
        }

        /* Developer Credit Animation */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .dev-credit-anim {
            animation: fade-in-up 0.5s ease-out forwards;
        }

        /* Contact Icon Pulse/Movement - بطيء وطائر */
        @keyframes pulse-glow {
            0%, 100% {
                transform: scale(1) translateY(0);
                box-shadow: 0 0 5px var(--primary-color);
                opacity: 0.9;
            }
            50% {
                transform: scale(1.05) translateY(-5px);
                box-shadow: 0 0 20px var(--primary-color), 0 0 30px rgba(139, 92, 246, 0.5);
                opacity: 1;
            }
        }
        .contact-icon-pulse {
            animation: pulse-glow 3s infinite ease-in-out;
        }
        
        /* Print Styles for CV Preview (Ensures clean, professional printout) */
        @media print {
            body * {
                visibility: hidden;
            }
            #cv-preview-container, #cv-preview-container * {
                visibility: visible;
            }
            #cv-preview-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                color: black !important;
                background: white !important;
                padding: 20px;
                box-shadow: none;
            }
            /* Ensure text-align is honored in print for RTL/LTR */
            [dir="rtl"] .cv-ats-section { text-align: right !important; }
            [dir="ltr"] .cv-ats-section { text-align: left !important; }
        }

        /* RTL/LTR adjustment for text align (Important for Arabic/English CV) */
        .text-start-lang { text-align: right; }
        .text-end-lang { text-align: left; }
        [dir="ltr"] .text-start-lang { text-align: left; }
        [dir="ltr"] .text-end-lang { text-align: right; }
        
        /* Custom style for futuristic-outline-btn (used in nav/wizard) */
        .futuristic-outline-btn {
            @apply px-4 py-2 rounded-xl font-bold transition-all duration-300 ease-in-out;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background-color: transparent;
        }
        .futuristic-outline-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        /* Fade-in animation for views */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body id="app-body">

    <div id="splash-screen" class="fixed inset-0 flex flex-col items-center justify-center z-50 bg-slate-950 transition-opacity duration-500 opacity-100">
        <svg id="signature-svg" width="400" height="150" viewBox="0 0 400 150" class="mb-6">
            <text id="signature-text" x="50%" y="70%" dominant-baseline="middle" text-anchor="middle" font-family="'Inter', sans-serif" font-size="48" font-weight="bold" fill="none">
                Mora – CVX
            </text>
        </svg>

        <p class="text-xl text-indigo-400 dev-text-3d opacity-0 transition-opacity duration-500" id="dev-credit">
            تصميم عمرو لطفي
        </p>
    </div>

    <div id="redirect-overlay" class="fixed inset-0 bg-slate-950/90 z-[60] hidden flex-col items-center justify-center transition-opacity duration-300 opacity-0">
        <h2 class="text-4xl font-extrabold text-indigo-400 mb-4 dev-text-3d" id="redirect-message"></h2>
        <p class="text-6xl font-bold text-white mb-6 dev-text-3d" id="redirect-timer"></p>
        <p class="text-lg text-gray-400 dev-text-3d">تطوير عمرو لطفي</p>
    </div>

    <div id="app-container" class="hidden min-h-screen">
        
        <header id="app-header" class="glass-card sticky top-0 z-40 p-4 flex justify-between items-center transition-all duration-300">
            <h1 class="text-3xl font-extrabold text-indigo-400 dev-text-3d">Mora – CVX</h1>
            <nav id="nav-links" class="hidden md:flex space-x-4 space-x-reverse md:space-x-4 md:space-x-reverse text-lg">
                </nav>
            <button id="mobile-menu-btn" class="text-white md:hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="12" x2="20" y2="12"></line><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="18" x2="20" y2="18"></line></svg>
            </button>
            <div id="lang-toggle-container" class="hidden md:block">
                </div>
        </header>

        <main id="main-view" class="p-4 md:p-8"></main>
        
        <div id="mobile-menu-overlay" class="fixed inset-0 bg-slate-950/90 z-40 hidden flex-col items-center justify-center transition-opacity duration-300 opacity-0">
            <button id="close-mobile-menu" class="absolute top-4 right-4 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <nav id="mobile-nav-links" class="flex flex-col space-y-6 text-2xl"></nav>
        </div>
    </div>


    <script>
        // Global State and Core Logic
        const moraCVX = (() => {
            const STORAGE_KEY_SPLASH = 'mora-cvx-splash-shown';
            const STORAGE_KEY_LANG = 'mora-cvx-language';
            const STORAGE_KEY_CV = 'mora-cvx-data';
            
            let state = {
                lang: localStorage.getItem(STORAGE_KEY_LANG) || 'ar',
                view: 'splash',
                cvData: JSON.parse(localStorage.getItem(STORAGE_KEY_CV)) || {
                    personal: {},
                    summary: '',
                    experience: [],
                    education: [],
                    skills: [],
                    languages: [],
                    courses: [],
                },
                cvWizardStep: 1,
                maxWizardStep: 7,
                isAuthReady: false,
                db: null,
                userId: null,
            };

            const elements = {
                body: document.getElementById('app-body'),
                splashScreen: document.getElementById('splash-screen'),
                appContainer: document.getElementById('app-container'),
                mainView: document.getElementById('main-view'),
                header: document.getElementById('app-header'),
                navLinks: document.getElementById('nav-links'),
                mobileNavLinks: document.getElementById('mobile-nav-links'),
                langToggleContainer: document.getElementById('lang-toggle-container'),
                mobileMenuBtn: document.getElementById('mobile-menu-btn'),
                mobileMenuOverlay: document.getElementById('mobile-menu-overlay'),
                closeMobileMenu: document.getElementById('close-mobile-menu'),
                devCredit: document.getElementById('dev-credit'),
                redirectOverlay: document.getElementById('redirect-overlay'),
                redirectMessage: document.getElementById('redirect-message'),
                redirectTimer: document.getElementById('redirect-timer'),
            };
            
            // --- FIREBASE AND DATA HANDLERS ---
            
            function setFirebaseReady(dbInstance, authInstance, uid) {
                state.db = dbInstance;
                state.userId = uid;
                state.isAuthReady = true;
                
                // Load data from Firestore and set up real-time listener
                if (state.db && state.userId && window.firebaseImports) {
                    const cvRef = window.firebaseImports.doc(state.db, `artifacts/${window.__app_id || 'default-mora-cvx'}/users/${state.userId}/cvs/main_cv`);
                    
                    // Real-time listener
                    window.firebaseImports.onSnapshot(cvRef, (doc) => {
                        if (doc.exists()) {
                            const data = doc.data().cvData;
                            if (data) {
                                state.cvData = JSON.parse(data); // Parse serialized JSON
                                render(); // Re-render when data changes (e.g., loaded or updated by another session)
                            }
                        } else {
                            // If document doesn't exist, save current local data
                            saveCVDataToFirestore();
                        }
                    }, (error) => {
                        console.error("Firestore Snapshot Error:", error);
                    });
                }
            }
            
            async function saveCVDataToFirestore() {
                if (!state.db || !state.userId || !window.firebaseImports) {
                    console.warn("Firestore not ready. Saving to Local Storage only.");
                    localStorage.setItem(STORAGE_KEY_CV, JSON.stringify(state.cvData));
                    return;
                }
                
                // Serialize CV data to a JSON string before saving
                const cvDataJson = JSON.stringify(state.cvData);
                const cvRef = window.firebaseImports.doc(state.db, `artifacts/${window.__app_id || 'default-mora-cvx'}/users/${state.userId}/cvs/main_cv`);
                
                try {
                    await window.firebaseImports.setDoc(cvRef, { cvData: cvDataJson, lastUpdated: new Date() }, { merge: true });
                    localStorage.setItem(STORAGE_KEY_CV, JSON.stringify(state.cvData)); // Backup to LS
                    console.log("CV Data saved to Firestore successfully.");
                } catch (error) {
                    console.error("Error saving CV data to Firestore:", error);
                }
            }
            
            // --- TRANSLATION DATA (Already complete) ---
            const T = {
                ar: {
                    appName: 'Mora – CVX',
                    developedBy: 'تصميم عمرو لطفي', // Changed to "تصميم" (design)
                    selectLangTitle: 'اختر لغة الواجهة والـ CV',
                    selectLangBtn: 'إنشاء سيرة ذاتية باللغة العربية',
                    navHome: 'الرئيسية',
                    navHowItWorks: 'كيف يعمل',
                    navPreview: 'نموذج معاينة',
                    navPolicy: 'سياسة الخصوصية',
                    navContact: 'تواصل معنا',
                    navChangeLang: 'تغيير اللغة',
                    heroTitle: 'ابنِ سيرتك الذاتية كأنها قادمة من المستقبل',
                    heroDesc: 'Mora – CVX يساعدك على إنشاء CV احترافي، منظم، ومتوافق مع أنظمة التوظيف ATS، باللغة العربية أو الإنجليزية، مع تصميم جذاب وانيميشن مميزة.',
                    heroBtn: 'ابدأ إنشاء السيرة الذاتية الآن',
                    featureATS: 'متوافق مع أنظمة ATS',
                    featureLang: 'يدعم العربية والإنجليزية',
                    featureDesign: 'تصميم مستقبلي مع انيميشن سلسة',
                    featureContact: 'يدعم الصورة الشخصية وبيانات التواصل الكاملة',
                    wizardTitle: 'منشئ السيرة الذاتية - الخطوة',
                    wizardSteps: [
                        'المعلومات الشخصية + الصورة',
                        'الملخص المهني',
                        'الخبرات العملية',
                        'التعليم',
                        'المهارات',
                        'اللغات والدورات',
                        'مراجعة البيانات'
                    ],
                    next: 'التالي',
                    back: 'السابق',
                    review: 'مراجعة',
                    finish: 'إنهاء ومعاينة',
                    // Form fields
                    fullName: 'الاسم الكامل',
                    jobTitle: 'المسمى الوظيفي',
                    phone: 'رقم الهاتف',
                    email: 'البريد الإلكتروني',
                    city: 'المدينة والدولة',
                    linkedin: 'رابط LinkedIn',
                    photo: 'صورة شخصية (رابط URL اختياري)',
                    summaryTitle: 'ملخص مهني',
                    summaryPlaceholder: 'اكتب ملخصًا موجزًا وقويًا يوضح خبرتك وأهدافك المهنية.',
                    workExpTitle: 'الخبرات العملية',
                    workExpAdd: 'إضافة خبرة عمل',
                    workTitle: 'المسمى الوظيفي',
                    workCompany: 'الشركة',
                    workStart: 'تاريخ البداية (مثل: 2020-03)',
                    workEnd: 'تاريخ النهاية (أو حتى الآن)',
                    workDesc: 'الإنجازات والمهام (نقاط، سطر لكل نقطة)',
                    // Contact Page
                    contactTitle: 'تواصل معنا',
                    contactIntro: 'لأي استفسار، تعاون، اقتراح، أو مشكلات تقنية متعلقة بتطبيق Mora – CVX، يمكنك التواصل معنا عبر أي من القنوات التالية:',
                    redirecting: 'جاري تحويلك إلى',
                    // Policy Page
                    policyTitle: 'سياسة الخصوصية',
                    policyContent: `
                        <p class="mb-4">في Mora – CVX، نحترم خصوصيتك ونلتزم بحماية بياناتك الشخصية. تهدف هذه السياسة إلى توضيح كيفية تعاملنا مع المعلومات التي تُدخلها داخل التطبيق عند إنشاء سيرتك الذاتية، وحقوقك تجاه هذه البيانات.</p>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">1. جمع واستخدام البيانات</h4>
                        <ul class="list-disc pr-6 space-y-2">
                            <li><strong>البيانات المدخلة:</strong> جميع البيانات التي يتم إدخالها في نموذج إنشاء السيرة الذاتية (بما في ذلك الاسم، الخبرات، المهارات، وغيرها) يتم استخدامها فقط لعرض وتنسيق وإنشاء ملف السيرة الذاتية الخاص بك.</li>
                            <li><strong>عدم جمع بيانات شخصية حساسة:</strong> لا يقوم التطبيق بجمع أو معالجة أي بيانات شخصية حساسة (مثل الدين، الانتماء العرقي، معلومات طبية) بدون إذن صريح وواضح.</li>
                        </ul>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">2. التخزين والأمان</h4>
                        <ul class="list-disc pr-6 space-y-2">
                            <li><strong>التخزين السحابي:</strong> يتم تخزين بيانات السيرة الذاتية الخاصة بك بشكل آمن في قاعدة بيانات Firestore السحابية (ضمن سياق تطبيقنا) لتمكينك من الوصول إلى سيرتك الذاتية وتعديلها في أي وقت ومن أي جهاز.</li>
                            <li><strong>التخزين المحلي (Local Storage):</strong> قد نستخدم التخزين المحلي لتخزين حالة العرض (مثل اللغة المختارة وما إذا كانت شاشة البداية قد ظهرت) لتحسين تجربة المستخدم.</li>
                            <li><strong>الأمان:</strong> نحن نتبع إجراءات أمنية قياسية لحماية بياناتك المخزنة، ولكن يرجى العلم أنه لا يوجد نظام أمان في الإنترنت يمكن ضمانه بنسبة 100%.</li>
                        </ul>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">3. مسؤولية المستخدم</h4>
                        <p>أنت المسؤول الوحيد عن دقة وصحة المحتوى الذي تدخله في سيرتك الذاتية وعن مشاركتها مع أطراف ثالثة. نحن لا نتحمل مسؤولية أي سوء استخدام للمعلومات المدخلة.</p>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">4. التغييرات على السياسة</h4>
                        <p>قد يتم تحديث سياسة الخصوصية هذه من وقت لآخر. سيتم نشر أي تغييرات على هذه الصفحة. يوصى بمراجعة هذه السياسة بشكل دوري.</p>
                        <p class="mt-8 text-sm text-gray-500">آخر تحديث: نوفمبر 2025</p>
                    `,
                    // CV Preview
                    downloadPDF: 'تحميل بصيغة PDF',
                    copyText: 'نسخ نص السيرة الذاتية',
                    backToEdit: 'العودة للتعديل',
                    // CV Sections
                    sectionPersonal: 'بيانات التواصل',
                    sectionSummary: 'الملخص المهني',
                    sectionWork: 'الخبرات العملية',
                    sectionEducation: 'التعليم',
                    sectionSkills: 'المهارات',
                    sectionLanguages: 'اللغات',
                    sectionCourses: 'الدورات والشهادات',
                    currentlyWork: 'حتى الآن',
                    level: 'المستوى',
                    addSkill: 'إضافة مهارة',
                    skillName: 'اسم المهارة',
                    skillLevel: 'مستوى الكفاءة (مثال: متقدم)',
                    language: 'اللغة',
                    courseName: 'اسم الدورة/الشهادة',
                    courseProvider: 'الجهة المانحة',
                    courseDate: 'تاريخ الانتهاء (سنة/شهر)',
                    educationDegree: 'المؤهل العلمي',
                    educationInstitution: 'المؤسسة التعليمية',
                    educationGradDate: 'تاريخ التخرج (سنة/شهر)',
                },
                en: {
                    appName: 'Mora – CVX',
                    developedBy: 'Design Amr Lotfy', // Changed to "Design"
                    selectLangTitle: 'Select Interface and CV Language',
                    selectLangBtn: 'Create CV in English',
                    navHome: 'Home',
                    navHowItWorks: 'How It Works',
                    navPreview: 'Preview Template',
                    navPolicy: 'Privacy Policy',
                    navContact: 'Contact Us',
                    navChangeLang: 'Change Language',
                    heroTitle: 'Build Your CV As If It Came From The Future',
                    heroDesc: 'Mora – CVX helps you create a professional, organized, and ATS-compliant CV, in Arabic or English, with an attractive design and unique animations.',
                    heroBtn: 'Start Building Your CV Now',
                    featureATS: 'ATS-Compliant Structure',
                    featureLang: 'Supports Arabic and English',
                    featureDesign: 'Futuristic Design with Smooth Animation',
                    featureContact: 'Supports Personal Photo and Full Contact Data',
                    wizardTitle: 'CV Builder - Step',
                    wizardSteps: [
                        'Personal Info & Photo',
                        'Professional Summary',
                        'Work Experience',
                        'Education',
                        'Skills',
                        'Languages & Courses',
                        'Review'
                    ],
                    next: 'Next',
                    back: 'Back',
                    review: 'Review',
                    finish: 'Finish & Preview',
                    // Form fields
                    fullName: 'Full Name',
                    jobTitle: 'Job Title',
                    phone: 'Phone Number',
                    email: 'Email',
                    city: 'City and Country',
                    linkedin: 'LinkedIn URL',
                    photo: 'Personal Photo (Optional URL)',
                    summaryTitle: 'Professional Summary',
                    summaryPlaceholder: 'Write a brief, powerful summary detailing your experience and professional objectives.',
                    workExpTitle: 'Work Experience',
                    workExpAdd: 'Add Work Experience',
                    workTitle: 'Job Title',
                    workCompany: 'Company',
                    workStart: 'Start Date (e.g., 2020-03)',
                    workEnd: 'End Date (or Present)',
                    workDesc: 'Achievements and Responsibilities (Bullet Points, one per line)',
                    // Contact Page
                    contactTitle: 'Contact Us',
                    contactIntro: 'For any inquiries, collaboration opportunities, suggestions, or technical issues related to Mora – CVX, feel free to reach out through any of the channels below:',
                    redirecting: 'Redirecting you to',
                    // Policy Page
                    policyTitle: 'Privacy Policy',
                    policyContent: `
                        <p class="mb-4">At Mora – CVX, we respect your privacy and are committed to protecting your personal data. This policy clarifies how we handle the information you enter into the application when creating your CV, and your rights regarding this data.</p>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">1. Data Collection and Use</h4>
                        <ul class="list-disc pl-6 space-y-2">
                            <li><strong>Input Data:</strong> All data entered into the CV creation form (including name, experience, skills, etc.) is used solely for the purpose of displaying, formatting, and generating your CV file.</li>
                            <li><strong>No Collection of Sensitive Personal Data:</strong> The application does not collect or process any sensitive personal data (such as religion, ethnic background, medical information) without explicit and clear permission.</li>
                        </ul>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">2. Storage and Security</h4>
                        <ul class="list-disc pl-6 space-y-2">
                            <li><strong>Cloud Storage:</strong> Your CV data is securely stored in the Firestore cloud database (within the context of our application) to enable you to access and edit your CV anytime and from any device.</li>
                            <li><strong>Local Storage:</strong> We may use Local Storage to save display state (such as the selected language and whether the splash screen has been shown) to improve user experience.</li>
                            <li><strong>Security:</strong> We follow standard security procedures to protect your stored data, but please be aware that no security system on the internet can be guaranteed 100%.</li>
                        </ul>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">3. User Responsibility</h4>
                        <p>You are solely responsible for the accuracy and correctness of the content you enter in your CV and for sharing it with third parties. We are not responsible for any misuse of the entered information.</p>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">4. Changes to the Policy</h4>
                        <p>This Privacy Policy may be updated from time to time. Any changes will be posted on this page. You are advised to review this policy periodically.</p>
                        <p class="mt-8 text-sm text-gray-500">Last updated: November 2025</p>
                    `,
                    // CV Preview
                    downloadPDF: 'Download as PDF',
                    copyText: 'Copy CV text',
                    backToEdit: 'Back to edit',
                    // CV Sections
                    sectionPersonal: 'Contact Information',
                    sectionSummary: 'Professional Summary',
                    sectionWork: 'Work Experience',
                    sectionEducation: 'Education',
                    sectionSkills: 'Skills',
                    sectionLanguages: 'Languages',
                    sectionCourses: 'Courses & Certifications',
                    currentlyWork: 'Present',
                    level: 'Level',
                    addSkill: 'Add Skill',
                    skillName: 'Skill Name',
                    skillLevel: 'Proficiency Level (e.g., Advanced)',
                    language: 'Language',
                    courseName: 'Course/Certification Name',
                    courseProvider: 'Issuing Authority',
                    courseDate: 'Completion Date (Year/Month)',
                    educationDegree: 'Degree/Qualification',
                    educationInstitution: 'Institution',
                    educationGradDate: 'Graduation Date (Year/Month)',
                }
            };

            // --- UI AND NAVIGATION RENDERING ---

            function updateDirection() {
                const dir = state.lang === 'ar' ? 'rtl' : 'ltr';
                elements.body.setAttribute('dir', dir);
                elements.body.lang = state.lang;
                // Update dynamic classes for text alignment based on language
                document.querySelectorAll('.text-start-lang').forEach(el => {
                    el.style.textAlign = dir === 'rtl' ? 'right' : 'left';
                });
                document.querySelectorAll('.text-end-lang').forEach(el => {
                    el.style.textAlign = dir === 'rtl' ? 'left' : 'right';
                });
            }

            function renderHeaderAndNav() {
                const t = T[state.lang];
                const links = [
                    { name: t.navHome, view: 'landing' },
                    { name: t.navPreview, view: 'preview' },
                    { name: t.navPolicy, view: 'policy' },
                    { name: t.navContact, view: 'contact' },
                ];
                
                // Navigation Links
                elements.navLinks.innerHTML = links.map(link => `
                    <a href="#" data-view="${link.view}" class="text-gray-300 hover:text-indigo-400 transition-colors duration-200 text-lg font-medium" onclick="moraCVX.changeView('${link.view}', event)">
                        ${link.name}
                    </a>
                `).join('<span class="text-gray-600">|</span>');

                // Mobile Navigation Links (duplicates for simplicity)
                elements.mobileNavLinks.innerHTML = links.map(link => `
                    <a href="#" data-view="${link.view}" class="text-gray-100 hover:text-indigo-400 transition-colors duration-200 text-3xl font-medium" onclick="moraCVX.changeView('${link.view}', event); moraCVX.toggleMobileMenu(false);">
                        ${link.name}
                    </a>
                `).join('');

                // Language Toggle
                const otherLang = state.lang === 'ar' ? 'en' : 'ar';
                const otherLangText = state.lang === 'ar' ? 'English' : 'العربية';
                elements.langToggleContainer.innerHTML = `
                    <button class="futuristic-outline-btn text-sm" onclick="moraCVX.changeLanguage('${otherLang}')">
                        ${t.navChangeLang} (${otherLangText})
                    </button>
                `;
            }

            function renderView() {
                elements.mainView.innerHTML = '';
                elements.appContainer.classList.remove('hidden');
                
                // Show header only on non-splash/non-language select views
                if (state.view !== 'splash' && state.view !== 'langSelect') {
                    elements.header.classList.remove('hidden');
                    renderHeaderAndNav();
                } else {
                    elements.header.classList.add('hidden');
                }

                switch (state.view) {
                    case 'langSelect':
                        elements.mainView.innerHTML = renderLanguageSelect();
                        break;
                    case 'landing':
                        elements.mainView.innerHTML = renderLandingPage();
                        break;
                    case 'wizard':
                        elements.mainView.innerHTML = renderCVWizard();
                        attachWizardEvents();
                        break;
                    case 'preview':
                        elements.mainView.innerHTML = renderCVPreview();
                        break;
                    case 'policy':
                        elements.mainView.innerHTML = renderPolicyPage();
                        break;
                    case 'contact':
                        elements.mainView.innerHTML = renderContactPage();
                        break;
                    default:
                        // Fallback to language select
                        state.view = 'langSelect';
                        elements.mainView.innerHTML = renderLanguageSelect();
                        break;
                }
                
                updateDirection();
            }
            
            // --- VIEW RENDERERS ---

            function renderLanguageSelect() {
                const t_ar = T.ar;
                const t_en = T.en;
                
                return `
                    <div class="flex flex-col items-center justify-center h-[calc(100vh-6rem)] md:h-[calc(100vh-12rem)] space-y-10 p-4 animate-fade-in">
                        <h2 class="text-4xl font-extrabold text-white dev-text-3d">${T.ar.appName}</h2>
                        <p class="text-lg text-gray-400">${t_ar.selectLangTitle} / ${t_en.selectLangTitle}</p>
                        
                        <div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-8 ${state.lang === 'ar' ? 'md:space-x-reverse' : ''}">
                            <button class="futuristic-btn text-xl" onclick="moraCVX.changeLanguage('ar'); moraCVX.changeView('landing')">
                                ${t_ar.selectLangBtn}
                            </button>
                            <button class="futuristic-btn text-xl" onclick="moraCVX.changeLanguage('en'); moraCVX.changeView('landing')">
                                ${t_en.selectLangBtn}
                            </button>
                        </div>
                    </div>
                `;
            }

            function renderLandingPage() {
                const t = T[state.lang];
                
                return `
                    <div class="flex flex-col md:flex-row items-center justify-between p-8 space-y-10 md:space-y-0 animate-fade-in">
                        <div class="md:w-1/2 space-y-6 text-start-lang">
                            <h1 class="text-5xl md:text-6xl font-extrabold text-white leading-tight">
                                ${t.heroTitle}
                            </h1>
                            <p class="text-xl text-gray-400">
                                ${t.heroDesc}
                            </p>
                            <button class="futuristic-btn text-xl mt-8" onclick="moraCVX.changeView('wizard')">
                                ${t.heroBtn}
                            </button>
                            <p class="mt-4 text-sm text-gray-500">User ID: ${state.userId || '...loading'}</p>
                        </div>
                        
                        <div class="md:w-1/2 grid grid-cols-2 gap-6 p-4">
                            ${[t.featureATS, t.featureLang, t.featureDesign, t.featureContact].map((feature, index) => `
                                <div class="glass-card p-6 rounded-2xl text-center flex flex-col items-center">
                                    <svg class="w-8 h-8 text-indigo-400 mb-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        ${index === 0 ? '<polyline points="20 6 9 17 4 12"></polyline>' : ''}
                                        ${index === 1 ? '<path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path><path d="M12 2v20M2 12h20"></path>' : ''}
                                        ${index === 2 ? '<path d="M14.5 4h5.5v5.5"></path><path d="M20 4L11 13"></path><path d="M3 21l9-9"></path>' : ''}
                                        ${index === 3 ? '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>' : ''}
                                    </svg>
                                    <p class="font-semibold text-lg">${feature}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // CV Builder Renderer
            function renderCVWizard() {
                const t = T[state.lang];
                const currentStep = state.cvWizardStep;
                const totalSteps = state.maxWizardStep;

                const stepContent = renderWizardStepContent(currentStep, t);
                
                return `
                    <div class="max-w-4xl mx-auto p-4 md:p-8 animate-fade-in">
                        <h2 class="text-3xl font-extrabold text-indigo-400 mb-6 text-center">${t.wizardTitle} ${currentStep} ${state.lang === 'ar' ? 'من' : 'of'} ${totalSteps}: ${t.wizardSteps[currentStep - 1]}</h2>

                        <div class="w-full bg-slate-800 rounded-full h-2.5 mb-10">
                            <div class="bg-indigo-500 h-2.5 rounded-full transition-all duration-500" style="width: ${((currentStep / totalSteps) * 100).toFixed(0)}%"></div>
                        </div>

                        <div id="wizard-content" class="glass-card p-6 md:p-10 rounded-2xl">
                            ${stepContent}
                        </div>

                        <div class="mt-8 flex justify-between">
                            <button id="back-btn" class="futuristic-outline-btn ${currentStep === 1 ? 'invisible' : ''}">
                                ${t.back}
                            </button>
                            ${currentStep < totalSteps 
                                ? `<button id="next-btn" class="futuristic-btn">
                                    ${t.next}
                                </button>` 
                                : `<button id="finish-btn" class="futuristic-btn bg-green-600 hover:bg-green-700">
                                    ${t.finish}
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }

            function renderWizardStepContent(step, t) {
                const data = state.cvData;
                let html = '';

                switch (step) {
                    case 1: // Personal Info
                        html = `
                            <h3 class="text-2xl font-bold mb-6 text-indigo-300 text-start-lang">${t.wizardSteps[0]}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${renderInput(t.fullName, 'fullName', data.personal.fullName || '', 'text')}
                                ${renderInput(t.jobTitle, 'jobTitle', data.personal.jobTitle || '', 'text')}
                                ${renderInput(t.phone, 'phone', data.personal.phone || '', 'tel')}
                                ${renderInput(t.email, 'email', data.personal.email || '', 'email')}
                                ${renderInput(t.city, 'city', data.personal.city || '', 'text')}
                                ${renderInput(t.linkedin, 'linkedin', data.personal.linkedin || '', 'url')}
                                ${renderInput(t.photo, 'photo', data.personal.photo || '', 'url', t.photo)}
                            </div>
                        `;
                        break;
                    case 2: // Professional Summary
                        html = `
                            <h3 class="text-2xl font-bold mb-6 text-indigo-300 text-start-lang">${t.wizardSteps[1]}</h3>
                            <label for="summary" class="block text-gray-400 mb-2 text-start-lang">${t.summaryTitle}</label>
                            <textarea id="summary" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-indigo-500 focus:border-indigo-500 min-h-[200px] text-white" placeholder="${t.summaryPlaceholder}">${data.summary || ''}</textarea>
                        `;
                        break;
                    case 3: // Work Experience
                        html = `
                            <h3 class="text-2xl font-bold mb-6 text-indigo-300 text-start-lang">${t.wizardSteps[2]}</h3>
                            <div id="work-experience-list" class="space-y-6">
                                ${data.experience.map((exp, index) => renderWorkExpItem(exp, index, t)).join('')}
                            </div>
                            <button id="add-work-exp-btn" class="futuristic-outline-btn mt-6 w-full flex items-center justify-center space-x-2 ${state.lang === 'ar' ? 'space-x-reverse' : ''}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>${t.workExpAdd}</span>
                            </button>
                        `;
                        break;
                    case 4: // Education
                        html = `
                            <h3 class="text-2xl font-bold mb-6 text-indigo-300 text-start-lang">${t.wizardSteps[3]}</h3>
                            <div id="education-list" class="space-y-6">
                                ${data.education.map((edu, index) => renderEducationItem(edu, index, t)).join('')}
                            </div>
                            <button id="add-education-btn" class="futuristic-outline-btn mt-6 w-full flex items-center justify-center space-x-2 ${state.lang === 'ar' ? 'space-x-reverse' : ''}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>${state.lang === 'ar' ? 'إضافة مؤهل علمي' : 'Add Educational Qualification'}</span>
                            </button>
                        `;
                        break;
                    case 5: // Skills
                        html = `
                            <h3 class="text-2xl font-bold mb-6 text-indigo-300 text-start-lang">${t.wizardSteps[4]}</h3>
                            <div id="skills-list" class="space-y-4">
                                ${data.skills.map((skill, index) => renderSkillItem(skill, index, t)).join('')}
                            </div>
                            <button id="add-skill-btn" class="futuristic-outline-btn mt-6 w-full flex items-center justify-center space-x-2 ${state.lang === 'ar' ? 'space-x-reverse' : ''}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>${t.addSkill}</span>
                            </button>
                        `;
                        break;
                    case 6: // Languages and Courses
                        html = `
                            <h3 class="text-2xl font-bold mb-6 text-indigo-300 text-start-lang">${t.wizardSteps[5]}</h3>
                            
                            <h4 class="text-xl font-semibold mt-8 mb-4 text-indigo-400 text-start-lang">${t.sectionLanguages}</h4>
                            <div id="languages-list" class="space-y-4">
                                ${data.languages.map((lang, index) => renderLanguageItem(lang, index, t)).join('')}
                            </div>
                            <button id="add-language-btn" class="futuristic-outline-btn mt-4 w-full flex items-center justify-center space-x-2 ${state.lang === 'ar' ? 'space-x-reverse' : ''}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>${state.lang === 'ar' ? 'إضافة لغة' : 'Add Language'}</span>
                            </button>
                            
                            <h4 class="text-xl font-semibold mt-8 mb-4 text-indigo-400 text-start-lang">${t.sectionCourses}</h4>
                            <div id="courses-list" class="space-y-4">
                                ${data.courses.map((course, index) => renderCourseItem(course, index, t)).join('')}
                            </div>
                            <button id="add-course-btn" class="futuristic-outline-btn mt-4 w-full flex items-center justify-center space-x-2 ${state.lang === 'ar' ? 'space-x-reverse' : ''}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>${state.lang === 'ar' ? 'إضافة دورة/شهادة' : 'Add Course/Certification'}</span>
                            </button>
                        `;
                        break;
                    case 7: // Review
                        html = `
                            <h3 class="text-2xl font-bold mb-6 text-indigo-300 text-start-lang">${t.wizardSteps[6]}</h3>
                            <p class="text-gray-400 mb-6 text-start-lang">${state.lang === 'ar' ? 'يمكنك مراجعة جميع البيانات المدخلة قبل الانتقال إلى المعاينة النهائية.' : 'You can review all entered data before proceeding to the final preview.'}</p>
                            
                            <div class="space-y-4 text-start-lang">
                                <div class="glass-card p-4 rounded-lg">
                                    <h4 class="font-bold text-indigo-300">${t.sectionPersonal}</h4>
                                    <p>${data.personal.fullName || '-'}</p>
                                    <p class="text-sm text-gray-400">${data.personal.jobTitle || '-'}</p>
                                </div>
                                <div class="glass-card p-4 rounded-lg">
                                    <h4 class="font-bold text-indigo-300">${t.sectionSummary}</h4>
                                    <p class="text-sm">${data.summary.substring(0, 150) || '-'}${data.summary.length > 150 ? '...' : ''}</p>
                                </div>
                                <div class="glass-card p-4 rounded-lg">
                                    <h4 class="font-bold text-indigo-300">${t.sectionWork} (${data.experience.length})</h4>
                                    <p class="text-sm text-gray-400">${data.experience.slice(0, 3).map(e => `${e.title} at ${e.company}`).join(' | ') || '-'}</p>
                                </div>
                                <div class="glass-card p-4 rounded-lg">
                                    <h4 class="font-bold text-indigo-300">${t.sectionSkills} (${data.skills.length})</h4>
                                    <p class="text-sm text-gray-400">${data.skills.slice(0, 5).map(s => s.name).join(', ') || '-'}</p>
                                </div>
                            </div>
                        `;
                        break;
                }
                return html;
            }
            
            // Helper function for input fields
            function renderInput(label, id, value, type = 'text', placeholder = '') {
                return `
                    <div class="mb-4">
                        <label for="${id}" class="block text-gray-400 mb-2 text-start-lang">${label}</label>
                        <input 
                            type="${type}" 
                            id="${id}" 
                            name="${id}" 
                            value="${value}" 
                            placeholder="${placeholder || label}"
                            class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:ring-indigo-500 focus:border-indigo-500"
                        >
                    </div>
                `;
            }

            // Helper for Work Experience item
            function renderWorkExpItem(exp, index, t) {
                return `
                    <div id="work-exp-item-${index}" class="glass-card p-4 rounded-lg relative">
                        <h4 class="font-bold text-indigo-400 mb-3 text-start-lang">${exp.title || t.workTitle}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            ${renderInput(t.workTitle, `workTitle-${index}`, exp.title || '', 'text')}
                            ${renderInput(t.workCompany, `workCompany-${index}`, exp.company || '', 'text')}
                            ${renderInput(t.workStart, `workStart-${index}`, exp.start || '', 'text')}
                            ${renderInput(t.workEnd, `workEnd-${index}`, exp.end || '', 'text', t.currentlyWork)}
                        </div>
                        <label for="workDesc-${index}" class="block text-gray-400 mb-2 text-start-lang">${t.workDesc}</label>
                        <textarea id="workDesc-${index}" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:ring-indigo-500 focus:border-indigo-500" rows="4">${exp.description || ''}</textarea>
                        <button onclick="moraCVX.removeItem('experience', ${index})" class="absolute top-2 ${state.lang === 'ar' ? 'left-2' : 'right-2'} text-red-500 hover:text-red-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;
            }

            // Helper for Education item
            function renderEducationItem(edu, index, t) {
                return `
                    <div id="edu-item-${index}" class="glass-card p-4 rounded-lg relative">
                        <h4 class="font-bold text-indigo-400 mb-3 text-start-lang">${edu.degree || t.educationDegree}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${renderInput(t.educationDegree, `eduDegree-${index}`, edu.degree || '', 'text')}
                            ${renderInput(t.educationInstitution, `eduInstitution-${index}`, edu.institution || '', 'text')}
                            ${renderInput(t.educationGradDate, `eduDate-${index}`, edu.date || '', 'text')}
                        </div>
                        <button onclick="moraCVX.removeItem('education', ${index})" class="absolute top-2 ${state.lang === 'ar' ? 'left-2' : 'right-2'} text-red-500 hover:text-red-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;
            }

            // Helper for Skill item
            function renderSkillItem(skill, index, t) {
                return `
                    <div id="skill-item-${index}" class="flex items-center space-x-4 ${state.lang === 'ar' ? 'space-x-reverse' : ''} glass-card p-3 rounded-lg">
                        <input type="text" id="skillName-${index}" value="${skill.name || ''}" placeholder="${t.skillName}" class="flex-grow p-2 rounded-lg bg-slate-800 border border-slate-700 text-white">
                        <input type="text" id="skillLevel-${index}" value="${skill.level || ''}" placeholder="${t.skillLevel}" class="w-1/3 p-2 rounded-lg bg-slate-800 border border-slate-700 text-white">
                        <button onclick="moraCVX.removeItem('skills', ${index})" class="text-red-500 hover:text-red-700 transition flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                `;
            }
            
            // Helper for Language item
            function renderLanguageItem(lang, index, t) {
                return `
                    <div id="lang-item-${index}" class="flex items-center space-x-4 ${state.lang === 'ar' ? 'space-x-reverse' : ''} glass-card p-3 rounded-lg">
                        <input type="text" id="langName-${index}" value="${lang.name || ''}" placeholder="${t.language}" class="flex-grow p-2 rounded-lg bg-slate-800 border border-slate-700 text-white">
                        <input type="text" id="langLevel-${index}" value="${lang.level || ''}" placeholder="${t.level}" class="w-1/3 p-2 rounded-lg bg-slate-800 border border-slate-700 text-white">
                        <button onclick="moraCVX.removeItem('languages', ${index})" class="text-red-500 hover:text-red-700 transition flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                `;
            }
            
            // Helper for Course item
            function renderCourseItem(course, index, t) {
                return `
                    <div id="course-item-${index}" class="glass-card p-4 rounded-lg relative">
                        <h4 class="font-bold text-indigo-400 mb-3 text-start-lang">${course.name || t.courseName}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${renderInput(t.courseName, `courseName-${index}`, course.name || '', 'text')}
                            ${renderInput(t.courseProvider, `courseProvider-${index}`, course.provider || '', 'text')}
                            ${renderInput(t.courseDate, `courseDate-${index}`, course.date || '', 'text')}
                        </div>
                        <button onclick="moraCVX.removeItem('courses', ${index})" class="absolute top-2 ${state.lang === 'ar' ? 'left-2' : 'right-2'} text-red-500 hover:text-red-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;
            }

            function renderContactPage() {
                const t = T[state.lang];
                // Added a 'link' data attribute to handle redirection with a timer
                const contacts = [
                    { name: 'Facebook', link: 'https://www.facebook.com/share/1CDtFCSPVD/', icon: `<path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>` },
                    { name: 'Instagram', link: 'https://www.instagram.com/eltopamr55?igsh=MWJ2MzJqaXBlZzRlaQ==', icon: `<rect width="20" height="20" x="2" y="2" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"></line>` },
                    { name: 'Telegram', link: 'https://t.me/elto47', icon: `<path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.3 8L12 14.5 7.7 10 12 6.5l4.3 3.5z"></path><path d="M12 12V6.5M12 12L8 9.5M12 12L16 9.5M8 14.5L12 10"></path><path d="M16 14.5L12 10"></path>` }, // Adjusted Telegram to be a cleaner icon
                    { name: 'Email', link: 'mailto:amrloutfy2006@gmail.com', icon: `<rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.83 1.83 0 0 1-2.06 0L2 7"></path>` },
                    { name: 'WhatsApp', link: 'https://wa.me/201067941806', icon: `<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>` }, // Simplified icon
                ];

                return `
                    <div class="max-w-4xl mx-auto p-4 md:p-8 text-start-lang animate-fade-in">
                        <h2 class="text-4xl font-extrabold text-indigo-400 mb-8">${t.contactTitle}</h2>
                        <p class="text-lg text-gray-300 mb-10">${t.contactIntro}</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${contacts.map(contact => `
                                <a href="#" data-link="${contact.link}" data-name="${contact.name}" onclick="moraCVX.showRedirectTimer(event)" class="glass-card p-6 rounded-2xl flex items-center space-x-4 ${state.lang === 'ar' ? 'space-x-reverse' : ''} hover:bg-white/10 transition-all duration-300 contact-icon-pulse">
                                    <svg class="w-8 h-8 text-indigo-400 dev-text-3d flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        ${contact.icon}
                                    </svg>
                                    <div>
                                        <h3 class="text-xl font-bold">${contact.name}</h3>
                                        <p class="text-sm text-gray-400">(${state.lang === 'ar' ? 'انقر للتحويل' : 'Click to redirect'})</p>
                                    </div>
                                </a>
                            `).join('')}
                        </div>
                        <p class="mt-8 text-sm text-gray-500">${t.developedBy}</p>
                    </div>
                `;
            }

            function renderPolicyPage() {
                const t = T[state.lang];
                return `
                    <div class="max-w-4xl mx-auto p-4 md:p-8 text-start-lang animate-fade-in">
                        <h2 class="text-4xl font-extrabold text-indigo-400 mb-8">${t.policyTitle}</h2>
                        <div class="glass-card p-6 md:p-10 rounded-2xl text-gray-300 leading-relaxed">
                            ${t.policyContent}
                        </div>
                    </div>
                `;
            }

            function renderCVPreview() {
                const t = T[state.lang];
                const data = state.cvData;
                const p = data.personal;
                
                // Sort work experience by start date (newest first for ATS)
                const sortedExperience = [...data.experience].sort((a, b) => {
                    const dateA = new Date(a.start || 0);
                    const dateB = new Date(b.start || 0);
                    return dateB - dateA; // Newest first
                });

                const cvContent = `
                    <div id="cv-content-ats" class="p-6 md:p-10 bg-white text-gray-800 shadow-xl rounded-lg relative print:shadow-none" style="width: 210mm; min-height: 297mm; direction: ${state.lang === 'ar' ? 'rtl' : 'ltr'}; font-family: 'Inter', sans-serif;">
                        
                        <div class="mb-6 pb-2 border-b-2 border-gray-600 cv-ats-section text-${state.lang === 'ar' ? 'right' : 'left'}">
                            <h1 class="text-3xl font-bold mb-1">${p.fullName || t.fullName}</h1>
                            <h2 class="text-xl text-gray-600 mb-3">${p.jobTitle || t.jobTitle}</h2>
                            <div class="text-sm text-gray-700 flex flex-wrap gap-x-4 ${state.lang === 'ar' ? 'justify-end' : 'justify-start'}">
                                ${p.city ? `<span><strong class="font-semibold">${p.city}</strong></span>` : ''}
                                ${p.city && (p.phone || p.email || p.linkedin) ? '<span>|</span>' : ''}
                                ${p.phone ? `<span>${p.phone}</span>` : ''}
                                ${p.phone && (p.email || p.linkedin) ? '<span>|</span>' : ''}
                                ${p.email ? `<span>${p.email}</span>` : ''}
                                ${p.email && p.linkedin ? '<span>|</span>' : ''}
                                ${p.linkedin ? `<span>LinkedIn: ${p.linkedin}</span>` : ''}
                            </div>
                            ${p.photo ? `<img src="${p.photo}" class="w-20 h-20 object-cover rounded-full absolute top-10 ${state.lang === 'ar' ? 'left-10' : 'right-10'}" alt="Photo">` : ''}
                        </div>

                        ${data.summary ? `
                        <div class="cv-ats-section mb-6" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                            <h3 class="text-lg font-bold uppercase mb-2 pb-1 border-b border-gray-400">${t.sectionSummary}</h3>
                            <p class="text-sm leading-relaxed whitespace-pre-wrap">${data.summary}</p>
                        </div>
                        ` : ''}

                        ${data.experience.length > 0 ? `
                            <div class="cv-ats-section mb-6" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                                <h3 class="text-lg font-bold uppercase mb-3 pb-1 border-b border-gray-400">${t.sectionWork}</h3>
                                ${sortedExperience.map(exp => `
                                    <div class="mb-4">
                                        <div class="flex justify-between items-start text-sm">
                                            <h4 class="font-bold">${exp.title || ''}${exp.company ? ` ${state.lang === 'ar' ? 'في' : 'at'} ${exp.company}` : ''}</h4>
                                            <span class="text-gray-600">${exp.start || ''} - ${exp.end || t.currentlyWork}</span>
                                        </div>
                                        ${exp.description ? `<ul class="list-disc ${state.lang === 'ar' ? 'pr-5' : 'pl-5'} text-sm mt-1 space-y-0.5">
                                            ${exp.description.split('\n').filter(line => line.trim()).map(line => `<li>${line.trim()}</li>`).join('')}
                                        </ul>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${data.education.length > 0 ? `
                            <div class="cv-ats-section mb-6" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                                <h3 class="text-lg font-bold uppercase mb-3 pb-1 border-b border-gray-400">${t.sectionEducation}</h3>
                                ${data.education.map(edu => `
                                    <div class="flex justify-between items-start text-sm mb-2">
                                        <h4 class="font-bold">${edu.degree || ''}</h4>
                                        <span class="text-gray-600">${edu.institution || ''} (${edu.date || ''})</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${data.skills.length > 0 ? `
                            <div class="cv-ats-section mb-6" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                                <h3 class="text-lg font-bold uppercase mb-3 pb-1 border-b border-gray-400">${t.sectionSkills}</h3>
                                <div class="flex flex-wrap gap-2 text-sm">
                                    ${data.skills.map(skill => `
                                        <span class="bg-gray-100 px-3 py-1 rounded-full text-gray-700 border border-gray-300">${skill.name} (${skill.level})</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex ${state.lang === 'ar' ? 'space-x-8 space-x-reverse' : 'space-x-8'}">
                            ${data.languages.length > 0 ? `
                                <div class="w-1/2 cv-ats-section">
                                    <h3 class="text-lg font-bold uppercase mb-3 pb-1 border-b border-gray-400">${t.sectionLanguages}</h3>
                                    <ul class="text-sm space-y-0.5" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                                        ${data.languages.map(lang => `<li>${lang.name}: ${lang.level}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${data.courses.length > 0 ? `
                                <div class="w-1/2 cv-ats-section">
                                    <h3 class="text-lg font-bold uppercase mb-3 pb-1 border-b border-gray-400">${t.sectionCourses}</h3>
                                    <ul class="text-sm space-y-0.5" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                                        ${data.courses.map(course => `<li>${course.name} (${course.provider}, ${course.date})</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>

                    </div>
                `;

                return `
                    <div class="max-w-7xl mx-auto p-4 md:p-8 animate-fade-in">
                        <h2 class="text-4xl font-extrabold text-indigo-400 mb-8 text-center">${t.wizardSteps[state.maxWizardStep - 1]}</h2>
                        
                        <div class="flex justify-center space-x-4 ${state.lang === 'ar' ? 'space-x-reverse' : ''} mb-8">
                            <button class="futuristic-btn bg-green-600 hover:bg-green-700" onclick="moraCVX.downloadPDF()">
                                ${t.downloadPDF}
                            </button>
                            <button class="futuristic-outline-btn" onclick="moraCVX.copyCVText()">
                                ${t.copyText}
                            </button>
                            <button class="futuristic-outline-btn" onclick="moraCVX.changeView('wizard', null, ${state.maxWizardStep})">
                                ${t.backToEdit}
                            </button>
                        </div>
                        
                        <div id="cv-preview-container" class="flex justify-center p-4 bg-gray-900 rounded-xl overflow-auto">
                            ${cvContent}
                        </div>
                    </div>
                `;
            }

            // --- WIZARD LOGIC (Existing code for data handling and navigation) ---

            function attachWizardEvents() {
                const contentDiv = document.getElementById('wizard-content');
                const backBtn = document.getElementById('back-btn');
                const nextBtn = document.getElementById('next-btn');
                const finishBtn = document.getElementById('finish-btn');
                
                // Navigation
                if (backBtn) backBtn.addEventListener('click', () => changeWizardStep(-1));
                if (nextBtn) nextBtn.addEventListener('click', () => changeWizardStep(1));
                if (finishBtn) finishBtn.addEventListener('click', () => changeView('preview'));
                
                // Dynamic List Adders
                if (state.cvWizardStep === 3) {
                    document.getElementById('add-work-exp-btn').addEventListener('click', () => { addItem('experience', { title: '', company: '', start: '', end: '', description: '' }); });
                }
                if (state.cvWizardStep === 4) {
                    document.getElementById('add-education-btn').addEventListener('click', () => { addItem('education', { degree: '', institution: '', date: '' }); });
                }
                if (state.cvWizardStep === 5) {
                    document.getElementById('add-skill-btn').addEventListener('click', () => { addItem('skills', { name: '', level: '' }); });
                }
                if (state.cvWizardStep === 6) {
                    document.getElementById('add-language-btn').addEventListener('click', () => { addItem('languages', { name: '', level: '' }); });
                    document.getElementById('add-course-btn').addEventListener('click', () => { addItem('courses', { name: '', provider: '', date: '' }); });
                }

                // Auto-save/Update on input change
                contentDiv.querySelectorAll('input, textarea').forEach(input => {
                    // Use 'blur' for non-step-changing save to reduce Firestore writes/localStorage updates
                    input.addEventListener('blur', updateCVData);
                });
            }

            function updateCVData() {
                const step = state.cvWizardStep;
                const data = state.cvData;

                switch (step) {
                    case 1: // Personal Info
                        data.personal.fullName = document.getElementById('fullName')?.value || '';
                        data.personal.jobTitle = document.getElementById('jobTitle')?.value || '';
                        data.personal.phone = document.getElementById('phone')?.value || '';
                        data.personal.email = document.getElementById('email')?.value || '';
                        data.personal.city = document.getElementById('city')?.value || '';
                        data.personal.linkedin = document.getElementById('linkedin')?.value || '';
                        data.personal.photo = document.getElementById('photo')?.value || '';
                        break;
                    case 2: // Professional Summary
                        data.summary = document.getElementById('summary')?.value || '';
                        break;
                    case 3: // Work Experience
                        data.experience = data.experience.map((exp, index) => ({
                            title: document.getElementById(`workTitle-${index}`)?.value || '',
                            company: document.getElementById(`workCompany-${index}`)?.value || '',
                            start: document.getElementById(`workStart-${index}`)?.value || '',
                            end: document.getElementById(`workEnd-${index}`)?.value || '',
                            description: document.getElementById(`workDesc-${index}`)?.value || '',
                        })).filter(exp => exp.title || exp.company); // Remove empty entries
                        break;
                    case 4: // Education
                        data.education = data.education.map((edu, index) => ({
                            degree: document.getElementById(`eduDegree-${index}`)?.value || '',
                            institution: document.getElementById(`eduInstitution-${index}`)?.value || '',
                            date: document.getElementById(`eduDate-${index}`)?.value || '',
                        })).filter(edu => edu.degree || edu.institution); // Remove empty entries
                        break;
                    case 5: // Skills
                        data.skills = data.skills.map((skill, index) => ({
                            name: document.getElementById(`skillName-${index}`)?.value || '',
                            level: document.getElementById(`skillLevel-${index}`)?.value || '',
                        })).filter(skill => skill.name); // Remove empty entries
                        break;
                    case 6: // Languages & Courses
                        data.languages = data.languages.map((lang, index) => ({
                            name: document.getElementById(`langName-${index}`)?.value || '',
                            level: document.getElementById(`langLevel-${index}`)?.value || '',
                        })).filter(lang => lang.name); // Remove empty entries
                        data.courses = data.courses.map((course, index) => ({
                            name: document.getElementById(`courseName-${index}`)?.value || '',
                            provider: document.getElementById(`courseProvider-${index}`)?.value || '',
                            date: document.getElementById(`courseDate-${index}`)?.value || '',
                        })).filter(course => course.name); // Remove empty entries
                        break;
                }

                saveCVDataToFirestore();
            }

            function changeWizardStep(delta) {
                // First, save data from the current step
                updateCVData();
                
                let newStep = state.cvWizardStep + delta;
                if (newStep >= 1 && newStep <= state.maxWizardStep) {
                    state.cvWizardStep = newStep;
                    // Animation: simple fade out/in
                    const content = document.getElementById('wizard-content');
                    if(content) {
                        content.classList.remove('animate-fade-in');
                        content.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                        setTimeout(() => {
                            renderView();
                            const newContent = document.getElementById('wizard-content');
                            if(newContent) {
                                newContent.classList.remove('opacity-0');
                                newContent.classList.add('animate-fade-in');
                            }
                        }, 300); // Wait for fade out
                    } else {
                        renderView();
                    }
                }
            }

            function addItem(section, defaultItem) {
                state.cvData[section].push(defaultItem);
                renderView(); // Re-render the wizard step to show new item
            }
            
            function removeItem(section, index) {
                state.cvData[section].splice(index, 1);
                saveCVDataToFirestore();
                renderView(); // Re-render the wizard step
            }

            // --- ACTION HANDLERS (PDF and Copy) ---
            
            function downloadPDF() {
                const element = document.getElementById('cv-content-ats');
                const t = T[state.lang];
                
                if (!element) return;
                
                // Custom options for html2pdf
                const options = {
                    margin: [10, 10, 10, 10], // top, left, bottom, right (10mm)
                    filename: (state.cvData.personal.fullName || 'CV') + '_Mora-CVX.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().from(element).set(options).save().then(() => {
                    // console.log("PDF generated.");
                }).catch(error => {
                    console.error("PDF generation failed:", error);
                    alert(`${t.lang === 'ar' ? 'فشل توليد ملف PDF. يرجى المحاولة مرة أخرى.' : 'PDF generation failed. Please try again.'}`);
                });
            }

            function copyCVText() {
                const element = document.getElementById('cv-content-ats');
                if (!element) return;

                // Create a text-only representation for copying
                const textContent = element.innerText;

                // Use the modern clipboard API if available
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textContent).then(() => {
                        showNotification(state.lang === 'ar' ? 'تم نسخ نص السيرة الذاتية بنجاح!' : 'CV text copied successfully!');
                    }).catch(err => {
                        console.error('Copy failed with modern API: ', err);
                        // Fallback to old method
                        fallbackCopyTextToClipboard(textContent);
                    });
                } else {
                    // Fallback for older browsers
                    fallbackCopyTextToClipboard(textContent);
                }
            }

            function fallbackCopyTextToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed'; 
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    const msg = successful ? (state.lang === 'ar' ? 'تم نسخ نص السيرة الذاتية بنجاح!' : 'CV text copied successfully!') : (state.lang === 'ar' ? 'فشل النسخ.' : 'Copy failed.');
                    showNotification(msg);
                } catch (err) {
                    console.error('Copy failed: ', err);
                    showNotification(state.lang === 'ar' ? 'فشل النسخ (يرجى المحاولة يدويًا).' : 'Copy failed (please try manually).', 'error');
                } finally {
                    document.body.removeChild(textarea);
                }
            }
            
            function showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 ${state.lang === 'ar' ? 'left-4' : 'right-4'} p-4 rounded-lg shadow-xl text-white z-50 transition-opacity duration-300 animate-fade-in`;
                notification.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Fade out and remove after 3 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            // --- REDIRECT TIMER LOGIC ---
            function showRedirectTimer(event) {
                event.preventDefault();
                const target = event.currentTarget;
                const url = target.getAttribute('data-link');
                const name = target.getAttribute('data-name');
                const t = T[state.lang];
                
                if (!url) return;

                elements.redirectMessage.textContent = `${t.redirecting} ${name}`;
                elements.redirectOverlay.classList.remove('hidden', 'opacity-0');
                elements.redirectOverlay.classList.add('opacity-100');

                let count = 3;
                elements.redirectTimer.textContent = count;

                const timerInterval = setInterval(() => {
                    count -= 1;
                    elements.redirectTimer.textContent = count;
                    
                    if (count <= 0) {
                        clearInterval(timerInterval);
                        window.location.href = url;
                        // Hide overlay immediately after redirect
                        elements.redirectOverlay.classList.remove('opacity-100');
                        elements.redirectOverlay.classList.add('opacity-0', 'hidden');
                    }
                }, 1000);

                // Add an emergency exit button just in case
                // For this example, we'll just let the timer run its course.
            }
            
            // --- CORE NAVIGATION/STATE FUNCTIONS ---

            function changeLanguage(lang) {
                state.lang = lang;
                localStorage.setItem(STORAGE_KEY_LANG, lang);
                renderView();
            }

            function changeView(view, event = null, step = 1) {
                if (event) event.preventDefault();
                state.view = view;
                if (view === 'wizard') {
                    state.cvWizardStep = step;
                }
                renderView();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            function toggleMobileMenu(show) {
                if (show === undefined) {
                    show = elements.mobileMenuOverlay.classList.contains('hidden');
                }
                if (show) {
                    elements.mobileMenuOverlay.classList.remove('hidden');
                    setTimeout(() => elements.mobileMenuOverlay.classList.remove('opacity-0'), 10);
                } else {
                    elements.mobileMenuOverlay.classList.add('opacity-0');
                    setTimeout(() => elements.mobileMenuOverlay.classList.add('hidden'), 300);
                }
            }
            
            function showSplash() {
                const splashShown = localStorage.getItem(STORAGE_KEY_SPLASH);
                
                if (splashShown) {
                    elements.splashScreen.classList.add('hidden');
                    state.view = 'langSelect';
                    renderView();
                    return;
                }
                
                // 1.5s for write-on effect, then show credit
                setTimeout(() => {
                    elements.devCredit.classList.add('dev-credit-anim'); // Apply professional fade-in
                    elements.devCredit.style.opacity = '1';
                }, 1500);

                // 2.5s display + 0.5s fade-out = 3s total
                setTimeout(() => {
                    // Start fading out logo and credit
                    elements.splashScreen.classList.remove('opacity-100');
                    elements.splashScreen.classList.add('opacity-0');
                }, 3000); // 3 seconds to ensure both animations run fully

                setTimeout(() => {
                    // Hide splash and proceed to app
                    elements.splashScreen.classList.add('hidden');
                    localStorage.setItem(STORAGE_KEY_SPLASH, 'true');
                    state.view = 'langSelect';
                    renderView();
                }, 3500); // Total 3.5 seconds before hiding
            }

            // --- INITIALIZATION ---

            function init() {
                // Initialize Firebase first
                window.initializeFirebase();
                
                // Add event listeners for mobile menu
                elements.mobileMenuBtn.addEventListener('click', () => toggleMobileMenu(true));
                elements.closeMobileMenu.addEventListener('click', () => toggleMobileMenu(false));
                
                // Start the app flow
                showSplash();
            }

            // Public interface
            return {
                init,
                changeLanguage,
                changeView,
                changeWizardStep,
                updateCVData,
                addItem,
                removeItem,
                downloadPDF,
                copyCVText,
                toggleMobileMenu,
                setFirebaseReady,
                showRedirectTimer, // Exposed for use in HTML
                state: () => state // For inspection only
            };
        })();

        window.moraCVX = moraCVX;
        document.addEventListener('DOMContentLoaded', moraCVX.init);
    </script>
</body>
</html>
