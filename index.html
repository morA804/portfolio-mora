<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mora – CVX | CV Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-mora-cvx';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        async function initializeFirebase() {
            try {
                if (!firebaseConfig) {
                    console.warn("Firebase config missing. Using placeholder.");
                    const placeholderConfig = {
                        apiKey: "AIzaSyC_PLACEHOLDER",
                        authDomain: "placeholder.firebaseapp.com",
                        projectId: "placeholder-project"
                    };
                    app = initializeApp(placeholderConfig, appId);
                } else {
                    app = initializeApp(firebaseConfig, appId);
                }
                db = getFirestore(app);
                auth = getAuth(app);
                window.firebaseImports = { doc, setDoc, getDoc, onSnapshot };
                const authPromise = new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        unsubscribe();
                        resolve();
                    });
                });
                await authPromise;
                if (window.moraCVX && window.moraCVX.setFirebaseReady) {
                    window.moraCVX.setFirebaseReady(db, auth, userId);
                }
            } catch (error) {
                console.error("Firebase init error:", error);
            }
        }
        window.initializeFirebase = initializeFirebase;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --primary-color: #6366f1;
            --bg-color: #0b0f1a;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            min-height: 100vh;
            color: #e5e7eb;
            overflow-x: hidden;
            margin: 0;
        }
        .glass-card {
            background-color: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1), 0 10px 15px -3px rgba(99, 102, 241, 0.15);
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.2), 0 20px 25px -5px rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }
        .futuristic-btn {
            @apply px-4 py-3 md:px-6 md:py-3 rounded-xl font-bold text-white shadow-lg transition-all duration-300 ease-in-out;
            background-image: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .futuristic-btn:hover {
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.7);
            transform: scale(1.02);
        }
        .futuristic-btn:active {
            transform: scale(0.98);
        }
        .dev-text-3d {
            text-shadow: 0 0 8px rgba(99, 102, 241, 0.8), 0 4px 8px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }
        #signature-text {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: write-on 1.5s ease-out forwards, text-glow 1.5s ease-in-out infinite alternate 1.5s;
            fill: #fff;
            stroke: var(--primary-color);
            stroke-width: 1;
        }
        @keyframes write-on {
            to { stroke-dashoffset: 0; }
        }
        @keyframes text-glow {
            from { text-shadow: 0 0 5px rgba(99, 102, 241, 0.4); }
            to { text-shadow: 0 0 20px rgba(99, 102, 241, 1), 0 0 30px rgba(139, 92, 246, 0.8); }
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dev-credit-anim {
            animation: fade-in-up 0.5s ease-out forwards;
        }
        @keyframes pulse-glow {
            0%, 100% {
                transform: scale(1) translateY(0);
                box-shadow: 0 0 5px var(--primary-color);
                opacity: 0.9;
            }
            50% {
                transform: scale(1.05) translateY(-5px);
                box-shadow: 0 0 20px var(--primary-color), 0 0 30px rgba(139, 92, 246, 0.5);
                opacity: 1;
            }
        }
        .contact-icon-pulse {
            animation: pulse-glow 3s infinite ease-in-out;
        }
        @media print {
            body * { visibility: hidden; }
            #cv-preview-container, #cv-preview-container * { visibility: visible; }
            #cv-preview-container { position: absolute; left: 0; top: 0; width: 100%; color: black !important; background: white !important; padding: 20px; box-shadow: none; }
            [dir="rtl"] .cv-ats-section { text-align: right !important; }
            [dir="ltr"] .cv-ats-section { text-align: left !important; }
        }
        .text-start-lang { text-align: right; }
        .text-end-lang { text-align: left; }
        [dir="ltr"] .text-start-lang { text-align: left; }
        [dir="ltr"] .text-end-lang { text-align: right; }
        .futuristic-outline-btn {
            @apply px-4 py-2 md:px-6 md:py-3 rounded-xl font-bold transition-all duration-300 ease-in-out;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background-color: transparent;
        }
        .futuristic-outline-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }
        .input-error-label {
            color: #ef4444 !important;
        }

        /* ✅ الخلفية المتحركة تظهر فقط في صفحة اختيار اللغة */
        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            display: none; /* مخفية افتراضيًا */
        }
        .lang-select-active #three-canvas {
            display: block;
        }

        /* Responsive tweaks */
        .step-title {
            font-size: 1.25rem;
            @apply md:text-2xl;
        }
        .cv-section-title {
            font-size: 1rem;
            @apply md:text-lg;
        }
        .wizard-content-container {
            padding: 1rem;
            @apply md:p-6;
        }
        .form-grid {
            grid-template-columns: 1fr;
            @apply md:grid-cols-2 lg:grid-cols-2 gap-4;
        }
        .skills-grid, .lang-grid {
            grid-template-columns: 1fr;
            @apply md:grid-cols-2 gap-4;
        }
        .contact-grid {
            grid-template-columns: 1fr;
            @apply sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4;
        }
        #cv-content-ats {
            width: 210mm;
            min-height: 297mm;
            max-width: 95vw;
            overflow: hidden;
        }
        #cv-preview-container {
            width: 100%;
            display: flex;
            justify-content: center;
            overflow-x: auto;
        }
    </style>
</head>
<body id="app-body" class="">
    <!-- Splash -->
    <div id="splash-screen" class="fixed inset-0 flex flex-col items-center justify-center z-50 bg-slate-950 transition-opacity duration-500 opacity-100">
        <svg id="signature-svg" width="300" height="100" viewBox="0 0 400 150" class="mb-6 w-full max-w-xs md:max-w-md">
            <text id="signature-text" x="50%" y="70%" dominant-baseline="middle" text-anchor="middle" font-family="'Inter', sans-serif" font-size="36" font-weight="bold" fill="none">
                Mora – CVX
            </text>
        </svg>
        <p class="text-lg md:text-xl text-indigo-400 dev-text-3d opacity-0 transition-opacity duration-500" id="dev-credit">
            تصميم عمرو لطفي
        </p>
    </div>

    <!-- Redirect Overlay -->
    <div id="redirect-overlay" class="fixed inset-0 bg-slate-950/90 z-[60] hidden flex-col items-center justify-center transition-opacity duration-300 opacity-0">
        <h2 class="text-3xl md:text-4xl font-extrabold text-indigo-400 mb-4 dev-text-3d" id="redirect-message"></h2>
        <p class="text-5xl md:text-6xl font-bold text-white mb-6 dev-text-3d" id="redirect-timer"></p>
        <p class="text-base md:text-lg text-gray-400 dev-text-3d">تطوير عمرو لطفي</p>
    </div>

    <!-- App -->
    <div id="app-container" class="hidden min-h-screen">
        <header id="app-header" class="glass-card sticky top-0 z-40 p-3 md:p-4 flex justify-between items-center transition-all duration-300">
            <h1 class="text-xl md:text-3xl font-extrabold text-indigo-400 dev-text-3d truncate">Mora – CVX</h1>
            <nav id="nav-links" class="hidden md:flex flex-wrap gap-x-3 md:gap-x-5 text-sm md:text-lg"></nav>
            <button id="mobile-menu-btn" class="text-white md:hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="12" x2="20" y2="12"></line><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="18" x2="20" y2="18"></line></svg>
            </button>
            <div id="lang-toggle-container" class="hidden md:block"></div>
        </header>
        <main id="main-view" class="p-2 md:p-4 lg:p-8"></main>
        <div id="mobile-menu-overlay" class="fixed inset-0 bg-slate-950/90 z-40 hidden flex-col items-center justify-center transition-opacity duration-300 opacity-0">
            <button id="close-mobile-menu" class="absolute top-4 right-4 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <nav id="mobile-nav-links" class="flex flex-col space-y-4 text-lg md:text-2xl px-4"></nav>
        </div>

        <!-- Canvas للخلفية (يُنشَأ ديناميكيًا فقط عند الحاجة) -->
        <canvas id="three-canvas"></canvas>
    </div>

    <script>
        const moraCVX = (() => {
            const STORAGE_KEY_SPLASH = 'mora-cvx-splash-shown';
            const STORAGE_KEY_LANG = 'mora-cvx-language';
            const STORAGE_KEY_CV = 'mora-cvx-data';
            let state = {
                lang: localStorage.getItem(STORAGE_KEY_LANG) || 'ar',
                view: 'splash',
                cvData: JSON.parse(localStorage.getItem(STORAGE_KEY_CV)) || {
                    personal: {},
                    summary: '',
                    experience: [],
                    education: [],
                    skills: [],
                    languages: [],
                    courses: [],
                },
                cvWizardStep: 1,
                maxWizardStep: 7,
                isAuthReady: false,
                db: null,
                userId: null,
            };

            const elements = {
                body: document.getElementById('app-body'),
                splashScreen: document.getElementById('splash-screen'),
                appContainer: document.getElementById('app-container'),
                mainView: document.getElementById('main-view'),
                header: document.getElementById('app-header'),
                navLinks: document.getElementById('nav-links'),
                mobileNavLinks: document.getElementById('mobile-nav-links'),
                langToggleContainer: document.getElementById('lang-toggle-container'),
                mobileMenuBtn: document.getElementById('mobile-menu-btn'),
                mobileMenuOverlay: document.getElementById('mobile-menu-overlay'),
                closeMobileMenu: document.getElementById('close-mobile-menu'),
                devCredit: document.getElementById('dev-credit'),
                redirectOverlay: document.getElementById('redirect-overlay'),
                redirectMessage: document.getElementById('redirect-message'),
                redirectTimer: document.getElementById('redirect-timer'),
                threeCanvas: document.getElementById('three-canvas'),
            };

            function setFirebaseReady(dbInstance, authInstance, uid) {
                state.db = dbInstance;
                state.userId = uid;
                state.isAuthReady = true;
                if (state.db && state.userId && window.firebaseImports) {
                    const cvRef = window.firebaseImports.doc(state.db, `artifacts/${window.__app_id || 'default-mora-cvx'}/users/${state.userId}/cvs/main_cv`);
                    window.firebaseImports.onSnapshot(cvRef, (doc) => {
                        if (doc.exists()) {
                            const data = doc.data().cvData;
                            if (data) {
                                state.cvData = JSON.parse(data);
                                render();
                            }
                        } else {
                            saveCVDataToFirestore();
                        }
                    });
                }
            }

            async function saveCVDataToFirestore() {
                if (!state.db || !state.userId || !window.firebaseImports) {
                    localStorage.setItem(STORAGE_KEY_CV, JSON.stringify(state.cvData));
                    return;
                }
                const cvDataJson = JSON.stringify(state.cvData);
                const cvRef = window.firebaseImports.doc(state.db, `artifacts/${window.__app_id || 'default-mora-cvx'}/users/${state.userId}/cvs/main_cv`);
                try {
                    await window.firebaseImports.setDoc(cvRef, { cvData: cvDataJson, lastUpdated: new Date() }, { merge: true });
                    localStorage.setItem(STORAGE_KEY_CV, JSON.stringify(state.cvData));
                } catch (error) {
                    console.error("Firestore save error:", error);
                }
            }

            const T = {
                ar: {
                    appName: 'Mora – CVX',
                    developedBy: 'تصميم عمرو لطفي',
                    selectLangTitle: 'اختر لغة الواجهة والـ CV',
                    selectLangBtn: 'إنشاء سيرة ذاتية باللغة العربية',
                    navHome: 'الرئيسية',
                    navHowItWorks: 'كيف يعمل',
                    navPreview: 'نموذج معاينة',
                    navPolicy: 'سياسة الخصوصية',
                    navContact: 'تواصل معنا',
                    navChangeLang: 'تغيير اللغة',
                    heroTitle: 'ابنِ سيرتك الذاتية باحترافية',
                    heroDesc: 'Mora – CVX يساعدك على إنشاء CV احترافي، منظم، ومتوافق مع أنظمة التوظيف ATS، باللغة العربية أو الإنجليزية، مع تصميم جذاب وانيميشن مميزة.',
                    heroBtn: 'ابدأ إنشاء السيرة الذاتية الآن',
                    featureATS: 'متوافق مع أنظمة ATS',
                    featureLang: 'يدعم العربية والإنجليزية',
                    featureDesign: 'تصميم مستقبلي مع انيميشن سلسة',
                    featureContact: 'يدعم الصورة الشخصية وبيانات التواصل الكاملة',
                    wizardTitle: 'منشئ السيرة الذاتية - الخطوة',
                    wizardSteps: [
                        'المعلومات الشخصية + الصورة',
                        'الملخص المهني',
                        'الخبرات العملية',
                        'التعليم',
                        'المهارات',
                        'اللغات والدورات',
                        'مراجعة البيانات'
                    ],
                    next: 'التالي',
                    back: 'السابق',
                    review: 'مراجعة',
                    finish: 'إنهاء ومعاينة',
                    fullName: 'الاسم الكامل',
                    jobTitle: 'المسمى الوظيفي',
                    phone: 'رقم الهاتف',
                    email: 'البريد الإلكتروني',
                    city: 'المدينة والدولة',
                    linkedin: 'رابط LinkedIn',
                    photoUpload: 'اختر صورة شخصية (اختياري)',
                    photoLabel: 'صورة شخصية',
                    summaryTitle: 'ملخص مهني',
                    summaryPlaceholder: 'اكتب ملخصًا موجزًا وقويًا يوضح خبرتك وأهدافك المهنية.',
                    workExpTitle: 'الخبرات العملية',
                    workExpAdd: 'إضافة خبرة عمل',
                    workTitle: 'المسمى الوظيفي',
                    workCompany: 'الشركة',
                    workStart: 'تاريخ البداية (مثل: 2020-03)',
                    workEnd: 'تاريخ النهاية (أو حتى الآن)',
                    workDesc: 'الإنجازات والمهام (نقاط، سطر لكل نقطة)',
                    requiredField: 'هذا الحقل مطلوب',
                    requiredAtLeastOne: 'يجب إضافة عنصر واحد على الأقل',
                    contactTitle: 'تواصل معنا',
                    contactIntro: 'لأي استفسار، تعاون، اقتراح، أو مشكلات تقنية متعلقة بتطبيق Mora – CVX، يمكنك التواصل معنا عبر أي من القنوات التالية:',
                    redirecting: 'جاري تحويلك إلى',
                    policyTitle: 'سياسة الخصوصية',
                    policyContent: `
                        <p class="mb-4">في Mora – CVX، نحترم خصوصيتك ونلتزم بحماية بياناتك الشخصية. تهدف هذه السياسة إلى توضيح كيفية تعاملنا مع المعلومات التي تُدخلها داخل التطبيق عند إنشاء سيرتك الذاتية، وحقوقك تجاه هذه البيانات.</p>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">1. جمع واستخدام البيانات</h4>
                        <ul class="list-disc pr-6 space-y-2">
                            <li><strong>البيانات المدخلة:</strong> جميع البيانات التي يتم إدخالها في نموذج إنشاء السيرة الذاتية (بما في ذلك الاسم، الخبرات، المهارات، وغيرها) يتم استخدامها فقط لعرض وتنسيق وإنشاء ملف السيرة الذاتية الخاص بك.</li>
                            <li><strong>عدم جمع بيانات شخصية حساسة:</strong> لا يقوم التطبيق بجمع أو معالجة أي بيانات شخصية حساسة (مثل الدين، الانتماء العرقي، معلومات طبية) بدون إذن صريح وواضح.</li>
                        </ul>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">2. التخزين والأمان</h4>
                        <ul class="list-disc pr-6 space-y-2">
                            <li><strong>التخزين السحابي:</strong> يتم تخزين بيانات السيرة الذاتية الخاصة بك بشكل آمن في قاعدة بيانات Firestore السحابية (ضمن سياق تطبيقنا) لتمكينك من الوصول إلى سيرتك الذاتية وتعديلها في أي وقت ومن أي جهاز.</li>
                            <li><strong>التخزين المحلي (Local Storage):</strong> قد نستخدم التخزين المحلي لتخزين حالة العرض (مثل اللغة المختارة وما إذا كانت شاشة البداية قد ظهرت) لتحسين تجربة المستخدم.</li>
                            <li><strong>الأمان:</strong> نحن نتبع إجراءات أمنية قياسية لحماية بياناتك المخزنة، ولكن يرجى العلم أنه لا يوجد نظام أمان في الإنترنت يمكن ضمانه بنسبة 100%.</li>
                        </ul>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">3. مسؤولية المستخدم</h4>
                        <p>أنت المسؤول الوحيد عن دقة وصحة المحتوى الذي تدخله في سيرتك الذاتية وعن مشاركتها مع أطراف ثالثة. نحن لا نتحمل مسؤولية أي سوء استخدام للمعلومات المدخلة.</p>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">4. التغييرات على السياسة</h4>
                        <p>قد يتم تحديث سياسة الخصوصية هذه من وقت لآخر. سيتم نشر أي تغييرات على هذه الصفحة. يوصى بمراجعة هذه السياسة بشكل دوري.</p>
                        <p class="mt-8 text-sm text-gray-500">آخر تحديث: نوفمبر 2025</p>
                    `,
                    downloadPDF: 'تحميل بصيغة PDF',
                    copyText: 'نسخ نص السيرة الذاتية',
                    backToEdit: 'العودة للتعديل',
                    sectionPersonal: 'بيانات التواصل',
                    sectionSummary: 'الملخص المهني',
                    sectionWork: 'الخبرات العملية',
                    sectionEducation: 'التعليم',
                    sectionSkills: 'المهارات',
                    sectionLanguages: 'اللغات',
                    sectionCourses: 'الدورات والشهادات',
                    currentlyWork: 'حتى الآن',
                    level: 'المستوى',
                    addSkill: 'إضافة مهارة',
                    skillName: 'اسم المهارة',
                    skillLevel: 'مستوى الكفاءة (مثال: متقدم)',
                    language: 'اللغة',
                    courseName: 'اسم الدورة/الشهادة',
                    courseProvider: 'الجهة المانحة',
                    courseDate: 'تاريخ الانتهاء (سنة/شهر)',
                    educationDegree: 'المؤهل العلمي',
                    educationInstitution: 'المؤسسة التعليمية',
                    educationGradDate: 'تاريخ التخرج (سنة/شهر)',
                },
                en: {
                    appName: 'Mora – CVX',
                    developedBy: 'Design Amr Lotfy',
                    selectLangTitle: 'Select Interface and CV Language',
                    selectLangBtn: 'Create CV in English',
                    navHome: 'Home',
                    navHowItWorks: 'How It Works',
                    navPreview: 'Preview Template',
                    navPolicy: 'Privacy Policy',
                    navContact: 'Contact Us',
                    navChangeLang: 'Change Language',
                    heroTitle: 'Build Your CV Professionally',
                    heroDesc: 'Mora – CVX helps you create a professional, organized, and ATS-compliant CV, in Arabic or English, with an attractive design and unique animations.',
                    heroBtn: 'Start Building Your CV Now',
                    featureATS: 'ATS-Compliant Structure',
                    featureLang: 'Supports Arabic and English',
                    featureDesign: 'Futuristic Design with Smooth Animation',
                    featureContact: 'Supports Personal Photo and Full Contact Data',
                    wizardTitle: 'CV Builder - Step',
                    wizardSteps: [
                        'Personal Info & Photo',
                        'Professional Summary',
                        'Work Experience',
                        'Education',
                        'Skills',
                        'Languages & Courses',
                        'Review'
                    ],
                    next: 'Next',
                    back: 'Back',
                    review: 'Review',
                    finish: 'Finish & Preview',
                    fullName: 'Full Name',
                    jobTitle: 'Job Title',
                    phone: 'Phone Number',
                    email: 'Email',
                    city: 'City and Country',
                    linkedin: 'LinkedIn URL',
                    photoUpload: 'Upload Personal Photo (Optional)',
                    photoLabel: 'Personal Photo',
                    summaryTitle: 'Professional Summary',
                    summaryPlaceholder: 'Write a brief, powerful summary detailing your experience and professional objectives.',
                    workExpTitle: 'Work Experience',
                    workExpAdd: 'Add Work Experience',
                    workTitle: 'Job Title',
                    workCompany: 'Company',
                    workStart: 'Start Date (e.g., 2020-03)',
                    workEnd: 'End Date (or Present)',
                    workDesc: 'Achievements and Responsibilities (Bullet Points, one per line)',
                    requiredField: 'This field is required',
                    requiredAtLeastOne: 'At least one item is required',
                    contactTitle: 'Contact Us',
                    contactIntro: 'For any inquiries, collaboration opportunities, suggestions, or technical issues related to Mora – CVX, feel free to reach out through any of the channels below:',
                    redirecting: 'Redirecting you to',
                    policyTitle: 'Privacy Policy',
                    policyContent: `
                        <p class="mb-4">At Mora – CVX, we respect your privacy and are committed to protecting your personal data. This policy clarifies how we handle the information you enter into the application when creating your CV, and your rights regarding this data.</p>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">1. Data Collection and Use</h4>
                        <ul class="list-disc pl-6 space-y-2">
                            <li><strong>Input Data:</strong> All data entered into the CV creation form (including name, experience, skills, etc.) is used solely for the purpose of displaying, formatting, and generating your CV file.</li>
                            <li><strong>No Collection of Sensitive Personal Data:</strong> The application does not collect or process any sensitive personal data (such as religion, ethnic background, medical information) without explicit and clear permission.</li>
                        </ul>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">2. Storage and Security</h4>
                        <ul class="list-disc pl-6 space-y-2">
                            <li><strong>Cloud Storage:</strong> Your CV data is securely stored in the Firestore cloud database (within the context of our application) to enable you to access and edit your CV anytime and from any device.</li>
                            <li><strong>Local Storage:</strong> We may use Local Storage to save display state (such as the selected language and whether the splash screen has been shown) to improve user experience.</li>
                            <li><strong>Security:</strong> We follow standard security procedures to protect your stored data, but please be aware that no security system on the internet can be guaranteed 100%.</li>
                        </ul>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">3. User Responsibility</h4>
                        <p>You are solely responsible for the accuracy and correctness of the content you enter in your CV and for sharing it with third parties. We are not responsible for any misuse of the entered information.</p>
                        <h4 class="text-xl font-bold mt-6 mb-2 text-indigo-300">4. Changes to the Policy</h4>
                        <p>This Privacy Policy may be updated from time to time. Any changes will be posted on this page. You are advised to review this policy periodically.</p>
                        <p class="mt-8 text-sm text-gray-500">Last updated: November 2025</p>
                    `,
                    downloadPDF: 'Download as PDF',
                    copyText: 'Copy CV text',
                    backToEdit: 'Back to edit',
                    sectionPersonal: 'Contact Information',
                    sectionSummary: 'Professional Summary',
                    sectionWork: 'Work Experience',
                    sectionEducation: 'Education',
                    sectionSkills: 'Skills',
                    sectionLanguages: 'Languages',
                    sectionCourses: 'Courses & Certifications',
                    currentlyWork: 'Present',
                    level: 'Level',
                    addSkill: 'Add Skill',
                    skillName: 'Skill Name',
                    skillLevel: 'Proficiency Level (e.g., Advanced)',
                    language: 'Language',
                    courseName: 'Course/Certification Name',
                    courseProvider: 'Issuing Authority',
                    courseDate: 'Completion Date (Year/Month)',
                    educationDegree: 'Degree/Qualification',
                    educationInstitution: 'Institution',
                    educationGradDate: 'Graduation Date (Year/Month)',
                }
            };

            function validateStep(step) {
                const t = T[state.lang];
                let valid = true;
                const getEl = id => document.getElementById(id);
                const setError = (id, msg) => {
                    const el = getEl(id);
                    if (el) {
                        el.classList.add('input-error');
                        const label = document.querySelector(`label[for="${id}"]`);
                        if (label) label.classList.add('input-error-label');
                    }
                    showNotification(msg, 'error');
                    valid = false;
                };
                const clearErrors = () => {
                    document.querySelectorAll('.input-error, .input-error-label').forEach(el => {
                        el.classList.remove('input-error', 'input-error-label');
                    });
                };
                clearErrors();
                switch (step) {
                    case 1:
                        if (!state.cvData.personal.fullName?.trim()) {
                            setError('fullName', t.requiredField);
                            valid = false;
                        }
                        break;
                    case 2:
                        if (!state.cvData.summary?.trim()) {
                            setError('summary', t.requiredField);
                            valid = false;
                        }
                        break;
                    case 3:
                        if (state.cvData.experience.length === 0 ||
                            !state.cvData.experience.some(e => e.title?.trim() && e.company?.trim())) {
                            showNotification(t.requiredAtLeastOne, 'error');
                            valid = false;
                        }
                        break;
                    case 4:
                        if (state.cvData.education.length === 0 ||
                            !state.cvData.education.some(e => e.degree?.trim() && e.institution?.trim())) {
                            showNotification(t.requiredAtLeastOne, 'error');
                            valid = false;
                        }
                        break;
                    case 5:
                        if (state.cvData.skills.length === 0 ||
                            !state.cvData.skills.some(s => s.name?.trim())) {
                            showNotification(t.requiredAtLeastOne, 'error');
                            valid = false;
                        }
                        break;
                }
                return valid;
            }

            function updateDirection() {
                const dir = state.lang === 'ar' ? 'rtl' : 'ltr';
                elements.body.setAttribute('dir', dir);
                elements.body.lang = state.lang;
                document.querySelectorAll('.text-start-lang').forEach(el => el.style.textAlign = dir === 'rtl' ? 'right' : 'left');
                document.querySelectorAll('.text-end-lang').forEach(el => el.style.textAlign = dir === 'rtl' ? 'left' : 'right');
            }

            function renderHeaderAndNav() {
                const t = T[state.lang];
                const links = [
                    { name: t.navHome, view: 'landing' },
                    { name: t.navPreview, view: 'preview' },
                    { name: t.navPolicy, view: 'policy' },
                    { name: t.navContact, view: 'contact' },
                ];
                elements.navLinks.innerHTML = links.map(link => `
                    <a href="#" data-view="${link.view}" class="text-gray-300 hover:text-indigo-400 transition-colors duration-200 text-sm md:text-lg font-medium whitespace-nowrap" onclick="moraCVX.changeView('${link.view}', event)">
                        ${link.name}
                    </a>
                `).join('<span class="text-gray-600 mx-1 md:mx-2">•</span>');
                elements.mobileNavLinks.innerHTML = links.map(link => `
                    <a href="#" data-view="${link.view}" class="text-gray-100 hover:text-indigo-400 transition-colors duration-200 text-lg md:text-xl font-medium py-2" onclick="moraCVX.changeView('${link.view}', event); moraCVX.toggleMobileMenu(false);">
                        ${link.name}
                    </a>
                `).join('');
                const otherLang = state.lang === 'ar' ? 'en' : 'ar';
                const otherLangText = state.lang === 'ar' ? 'English' : 'العربية';
                elements.langToggleContainer.innerHTML = `
                    <button class="futuristic-outline-btn text-xs md:text-sm px-3 py-1 md:px-4 md:py-2" onclick="moraCVX.changeLanguage('${otherLang}')">
                        ${t.navChangeLang} (${otherLangText})
                    </button>
                `;
            }

            function renderView() {
                elements.mainView.innerHTML = '';
                elements.appContainer.classList.remove('hidden');

                // ✅ إدارة ظهور/إخفاء الخلفية المتحركة
                if (state.view === 'langSelect') {
                    elements.body.classList.add('lang-select-active');
                } else {
                    elements.body.classList.remove('lang-select-active');
                }

                if (state.view !== 'splash' && state.view !== 'langSelect') {
                    elements.header.classList.remove('hidden');
                    renderHeaderAndNav();
                } else {
                    elements.header.classList.add('hidden');
                }

                switch (state.view) {
                    case 'langSelect':
                        elements.mainView.innerHTML = renderLanguageSelect();
                        initThreeJSBackground();
                        break;
                    case 'landing':
                        elements.mainView.innerHTML = renderLandingPage();
                        break;
                    case 'wizard':
                        elements.mainView.innerHTML = renderCVWizard();
                        attachWizardEvents();
                        break;
                    case 'preview':
                        elements.mainView.innerHTML = renderCVPreview();
                        break;
                    case 'policy':
                        elements.mainView.innerHTML = renderPolicyPage();
                        break;
                    case 'contact':
                        elements.mainView.innerHTML = renderContactPage();
                        break;
                    default:
                        state.view = 'langSelect';
                        elements.mainView.innerHTML = renderLanguageSelect();
                        initThreeJSBackground();
                        break;
                }
                updateDirection();
            }

            let scene, camera, renderer, particles;
            let animationId = null;

            function initThreeJSBackground() {
                if (state.view !== 'langSelect') return;
                if (renderer) renderer.dispose();
                const canvas = elements.threeCanvas;
                const w = window.innerWidth;
                const h = window.innerHeight;
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, w / h, 0.1, 1000);
                camera.position.z = 5;
                renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.setSize(w, h);
                const particlesGeometry = new THREE.BufferGeometry();
                const particleCount = Math.max(500, Math.floor((w * h) / 3000));
                const posArray = new Float32Array(particleCount * 3);
                for (let i = 0; i < particleCount * 3; i++) {
                    posArray[i] = (Math.random() - 0.5) * 20;
                }
                particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
                const particlesMaterial = new THREE.PointsMaterial({
                    color: 0x6366f1,
                    size: window.innerWidth < 640 ? 0.03 : 0.05,
                    transparent: true,
                    opacity: 0.7,
                    sizeAttenuation: true
                });
                particles = new THREE.Points(particlesGeometry, particlesMaterial);
                scene.add(particles);
                const texts = ['CV', 'Exp', 'Edu', 'Skills', 'Mora', 'ATS'];
                const meshCount = window.innerWidth < 640 ? 10 : 30;
                for (let i = 0; i < meshCount; i++) {
                    const geo = new THREE.SphereGeometry(0.07 + Math.random() * 0.12, 16, 16);
                    const mat = new THREE.MeshBasicMaterial({
                        color: i % 3 === 0 ? 0x6366f1 : i % 3 === 1 ? 0x8b5cf6 : 0x10b981,
                        transparent: true,
                        opacity: 0.82
                    });
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.set(
                        (Math.random() - 0.5) * 12,
                        (Math.random() - 0.5) * 12,
                        (Math.random() - 0.5) * 12
                    );
                    mesh.userData = {
                        vx: (Math.random() - 0.5) * 0.017,
                        vy: (Math.random() - 0.5) * 0.017,
                        vz: (Math.random() - 0.5) * 0.017
                    };
                    scene.add(mesh);
                }
                const animate = () => {
                    animationId = requestAnimationFrame(animate);
                    particles.rotation.x += 0.0002;
                    particles.rotation.y += 0.0003;
                    scene.traverse(child => {
                        if (child.isMesh && child.userData.vx !== undefined) {
                            child.position.x += child.userData.vx;
                            child.position.y += child.userData.vy;
                            child.position.z += child.userData.vz;
                            if (Math.abs(child.position.x) > 12) child.userData.vx *= -1;
                            if (Math.abs(child.position.y) > 12) child.userData.vy *= -1;
                            if (Math.abs(child.position.z) > 12) child.userData.vz *= -1;
                        }
                    });
                    renderer.render(scene, camera);
                };
                animate();
                const resize = () => {
                    const w = window.innerWidth;
                    const h = window.innerHeight;
                    camera.aspect = w / h;
                    camera.updateProjectionMatrix();
                    renderer.setSize(w, h);
                };
                window.addEventListener('resize', resize);
            }

            function destroyThreeJS() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                if (renderer) {
                    renderer.dispose();
                    renderer = null;
                }
                // لا نحذف العنصر، فقط نوقف العرض
            }

            function renderLanguageSelect() {
                const t_ar = T.ar;
                const t_en = T.en;
                return `
                    <div class="lang-select-content flex flex-col items-center justify-center min-h-screen p-4 animate-fade-in">
                        <h2 class="text-3xl md:text-4xl font-extrabold text-white dev-text-3d text-center px-4">${T.ar.appName}</h2>
                        <p class="text-base md:text-lg text-gray-400 text-center mt-4 px-2">${t_ar.selectLangTitle} / ${t_en.selectLangTitle}</p>
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 ${state.lang === 'ar' ? 'sm:space-x-reverse' : ''} mt-8">
                            <button class="futuristic-btn text-lg px-6 py-3 w-full sm:w-auto" onclick="moraCVX.changeLanguage('ar'); moraCVX.changeView('landing')">
                                ${t_ar.selectLangBtn}
                            </button>
                            <button class="futuristic-btn text-lg px-6 py-3 w-full sm:w-auto" onclick="moraCVX.changeLanguage('en'); moraCVX.changeView('landing')">
                                ${t_en.selectLangBtn}
                            </button>
                        </div>
                    </div>
                `;
            }

            function renderLandingPage() {
                const t = T[state.lang];
                return `
                    <div class="flex flex-col md:flex-row items-center justify-between gap-10 p-4 md:p-8 animate-fade-in">
                        <div class="md:w-1/2 space-y-6 text-start-lang">
                            <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-white leading-tight">
                                ${t.heroTitle}
                            </h1>
                            <p class="text-base md:text-lg text-gray-400">
                                ${t.heroDesc}
                            </p>
                            <button class="futuristic-btn text-lg md:text-xl px-6 py-3 mt-6 md:mt-8 w-full md:w-auto" onclick="moraCVX.changeView('wizard')">
                                ${t.heroBtn}
                            </button>
                            <p class="mt-4 text-xs md:text-sm text-gray-500 truncate">User ID: ${state.userId || '...'}</p>
                        </div>
                        <div class="md:w-1/2 w-full grid grid-cols-2 gap-4 md:gap-6 p-2 md:p-4">
                            ${[t.featureATS, t.featureLang, t.featureDesign, t.featureContact].map((feature, index) => `
                                <div class="glass-card p-4 md:p-6 rounded-xl text-center flex flex-col items-center">
                                    <svg class="w-6 h-6 md:w-8 md:h-8 text-indigo-400 mb-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        ${index === 0 ? '<polyline points="20 6 9 17 4 12"></polyline>' : ''}
                                        ${index === 1 ? '<path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path><path d="M12 2v20M2 12h20"></path>' : ''}
                                        ${index === 2 ? '<path d="M14.5 4h5.5v5.5"></path><path d="M20 4L11 13"></path><path d="M3 21l9-9"></path>' : ''}
                                        ${index === 3 ? '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>' : ''}
                                    </svg>
                                    <p class="font-semibold text-sm md:text-base">${feature}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            function renderInput(label, id, value, type = 'text', placeholder = '', isRequired = false) {
                return `
                    <div class="mb-3 md:mb-4">
                        <label for="${id}" class="block text-gray-400 mb-1 text-sm md:text-base text-start-lang">${label}${isRequired ? ' *' : ''}</label>
                        <input 
                            type="${type}" 
                            id="${id}" 
                            name="${id}" 
                            value="${value}" 
                            placeholder="${placeholder || label}"
                            class="w-full p-2 md:p-3 rounded-lg bg-slate-800 border border-slate-700 text-white focus:ring-indigo-500 focus:border-indigo-500 text-sm md:text-base"
                        >
                    </div>
                `;
            }

            function renderPhotoUpload(t) {
                const hasPhoto = state.cvData.personal.photo;
                return `
                    <div class="mb-4">
                        <label class="block text-gray-400 mb-2 text-sm md:text-base text-start-lang">${t.photoLabel}</label>
                        <div class="flex items-center flex-wrap gap-2">
                            <input type="file" id="photo-upload" accept="image/*" class="hidden" />
                            <label for="photo-upload" class="futuristic-outline-btn text-sm px-3 py-2 flex items-center gap-1 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                <span>${t.photoUpload}</span>
                            </label>
                            ${hasPhoto ? `<img id="photo-preview" src="${state.cvData.personal.photo}" class="w-12 h-12 md:w-16 md:h-16 object-cover rounded-lg border border-slate-700 mt-1" alt="Photo">` : ''}
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${state.lang === 'ar' ? 'يتم تخزين الصورة محليًا فقط (لا تُرفع للسحابة).' : 'Image stored locally only (not uploaded to cloud).'}</p>
                    </div>
                `;
            }

            function renderCVWizard() {
                const t = T[state.lang];
                const currentStep = state.cvWizardStep;
                const totalSteps = state.maxWizardStep;
                const stepContent = renderWizardStepContent(currentStep, t);
                return `
                    <div class="max-w-6xl mx-auto p-2 md:p-4 lg:p-6 animate-fade-in">
                        <h2 class="text-xl md:text-2xl lg:text-3xl font-extrabold text-indigo-400 mb-4 text-center step-title">
                            ${t.wizardTitle} ${currentStep} ${state.lang === 'ar' ? 'من' : 'of'} ${totalSteps}: ${t.wizardSteps[currentStep - 1]}
                        </h2>
                        <div class="w-full bg-slate-800 rounded-full h-2 mb-6 md:mb-8">
                            <div class="bg-indigo-500 h-2 rounded-full transition-all duration-500" style="width: ${((currentStep / totalSteps) * 100).toFixed(0)}%"></div>
                        </div>
                        <div id="wizard-content" class="glass-card wizard-content-container rounded-xl md:rounded-2xl">
                            ${stepContent}
                        </div>
                        <div class="mt-6 md:mt-8 flex flex-col sm:flex-row justify-between gap-3">
                            <button id="back-btn" class="futuristic-outline-btn px-4 py-2 text-sm md:text-base ${currentStep === 1 ? 'invisible' : ''}">
                                ${t.back}
                            </button>
                            ${currentStep < totalSteps 
                                ? `<button id="next-btn" class="futuristic-btn flex-1 sm:flex-none px-4 py-2 text-sm md:text-base">
                                    ${t.next}
                                </button>` 
                                : `<button id="finish-btn" class="futuristic-btn bg-green-600 hover:bg-green-700 flex-1 sm:flex-none px-4 py-2 text-sm md:text-base">
                                    ${t.finish}
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }

            function renderWizardStepContent(step, t) {
                const data = state.cvData;
                let html = '';
                switch (step) {
                    case 1:
                        html = `
                            <h3 class="text-lg md:text-xl font-bold mb-4 md:mb-6 text-indigo-300 cv-section-title text-start-lang">${t.wizardSteps[0]}</h3>
                            <div class="form-grid">
                                ${renderInput(t.fullName, 'fullName', data.personal.fullName || '', 'text', '', true)}
                                ${renderInput(t.jobTitle, 'jobTitle', data.personal.jobTitle || '', 'text')}
                                ${renderInput(t.phone, 'phone', data.personal.phone || '', 'tel')}
                                ${renderInput(t.email, 'email', data.personal.email || '', 'email')}
                                ${renderInput(t.city, 'city', data.personal.city || '', 'text')}
                                ${renderInput(t.linkedin, 'linkedin', data.personal.linkedin || '', 'url')}
                                ${renderPhotoUpload(t)}
                            </div>
                        `;
                        break;
                    case 2:
                        html = `
                            <h3 class="text-lg md:text-xl font-bold mb-4 md:mb-6 text-indigo-300 cv-section-title text-start-lang">${t.wizardSteps[1]}</h3>
                            <label for="summary" class="block text-gray-400 mb-2 text-sm md:text-base text-start-lang">${t.summaryTitle} *</label>
                            <textarea id="summary" class="w-full p-2 md:p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-indigo-500 focus:border-indigo-500 min-h-[150px] md:min-h-[200px] text-white text-sm md:text-base" placeholder="${t.summaryPlaceholder}">${data.summary || ''}</textarea>
                        `;
                        break;
                    case 3:
                        html = `
                            <h3 class="text-lg md:text-xl font-bold mb-4 md:mb-6 text-indigo-300 cv-section-title text-start-lang">${t.wizardSteps[2]}</h3>
                            <div id="work-experience-list" class="space-y-4 md:space-y-6">
                                ${data.experience.map((exp, index) => renderWorkExpItem(exp, index, t)).join('')}
                            </div>
                            <button id="add-work-exp-btn" class="futuristic-outline-btn mt-4 md:mt-6 w-full flex items-center justify-center gap-1 text-sm md:text-base">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>${t.workExpAdd}</span>
                            </button>
                        `;
                        break;
                    case 4:
                        html = `
                            <h3 class="text-lg md:text-xl font-bold mb-4 md:mb-6 text-indigo-300 cv-section-title text-start-lang">${t.wizardSteps[3]}</h3>
                            <div id="education-list" class="space-y-4 md:space-y-6">
                                ${data.education.map((edu, index) => renderEducationItem(edu, index, t)).join('')}
                            </div>
                            <button id="add-education-btn" class="futuristic-outline-btn mt-4 md:mt-6 w-full flex items-center justify-center gap-1 text-sm md:text-base">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>${state.lang === 'ar' ? 'إضافة مؤهل علمي' : 'Add Educational Qualification'}</span>
                            </button>
                        `;
                        break;
                    case 5:
                        html = `
                            <h3 class="text-lg md:text-xl font-bold mb-4 md:mb-6 text-indigo-300 cv-section-title text-start-lang">${t.wizardSteps[4]}</h3>
                            <div id="skills-list" class="space-y-3">
                                ${data.skills.map((skill, index) => renderSkillItem(skill, index, t)).join('')}
                            </div>
                            <button id="add-skill-btn" class="futuristic-outline-btn mt-4 md:mt-6 w-full flex items-center justify-center gap-1 text-sm md:text-base">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>${t.addSkill}</span>
                            </button>
                        `;
                        break;
                    case 6:
                        html = `
                            <h3 class="text-lg md:text-xl font-bold mb-4 md:mb-6 text-indigo-300 cv-section-title text-start-lang">${t.wizardSteps[5]}</h3>
                            <h4 class="text-base md:text-lg font-semibold mt-6 mb-3 text-indigo-400 text-start-lang">${t.sectionLanguages}</h4>
                            <div id="languages-list" class="skills-grid space-y-3">
                                ${data.languages.map((lang, index) => renderLanguageItem(lang, index, t)).join('')}
                            </div>
                            <button id="add-language-btn" class="futuristic-outline-btn mt-3 md:mt-4 w-full flex items-center justify-center gap-1 text-sm md:text-base">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>${state.lang === 'ar' ? 'إضافة لغة' : 'Add Language'}</span>
                            </button>
                            <h4 class="text-base md:text-lg font-semibold mt-6 mb-3 text-indigo-400 text-start-lang">${t.sectionCourses}</h4>
                            <div id="courses-list" class="space-y-4">
                                ${data.courses.map((course, index) => renderCourseItem(course, index, t)).join('')}
                            </div>
                            <button id="add-course-btn" class="futuristic-outline-btn mt-3 md:mt-4 w-full flex items-center justify-center gap-1 text-sm md:text-base">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                <span>${state.lang === 'ar' ? 'إضافة دورة/شهادة' : 'Add Course/Certification'}</span>
                            </button>
                        `;
                        break;
                    case 7:
                        html = `
                            <h3 class="text-lg md:text-xl font-bold mb-4 md:mb-6 text-indigo-300 cv-section-title text-start-lang">${t.wizardSteps[6]}</h3>
                            <p class="text-gray-400 mb-4 md:mb-6 text-sm md:text-base text-start-lang">${state.lang === 'ar' ? 'يمكنك مراجعة جميع البيانات المدخلة قبل الانتقال إلى المعاينة النهائية.' : 'You can review all entered data before proceeding to the final preview.'}</p>
                            <div class="space-y-3 md:space-y-4 text-start-lang">
                                <div class="glass-card p-3 md:p-4 rounded-lg">
                                    <h4 class="font-bold text-indigo-300 text-base md:text-lg">${t.sectionPersonal}</h4>
                                    <p class="font-medium">${data.personal.fullName || '-'}</p>
                                    <p class="text-sm text-gray-400">${data.personal.jobTitle || '-'}</p>
                                </div>
                                <div class="glass-card p-3 md:p-4 rounded-lg">
                                    <h4 class="font-bold text-indigo-300 text-base md:text-lg">${t.sectionSummary}</h4>
                                    <p class="text-sm md:text-base">${data.summary.substring(0, 100) || '-'}${data.summary.length > 100 ? '...' : ''}</p>
                                </div>
                                <div class="glass-card p-3 md:p-4 rounded-lg">
                                    <h4 class="font-bold text-indigo-300 text-base md:text-lg">${t.sectionWork} (${data.experience.length})</h4>
                                    <p class="text-sm text-gray-400">${data.experience.slice(0, 2).map(e => `${e.title} ${state.lang === 'ar' ? 'في' : 'at'} ${e.company}`).join(' • ') || '-'}</p>
                                </div>
                                <div class="glass-card p-3 md:p-4 rounded-lg">
                                    <h4 class="font-bold text-indigo-300 text-base md:text-lg">${t.sectionSkills} (${data.skills.length})</h4>
                                    <p class="text-sm text-gray-400">${data.skills.slice(0, 4).map(s => s.name).join(', ') || '-'}</p>
                                </div>
                            </div>
                        `;
                        break;
                }
                return html;
            }

            function renderWorkExpItem(exp, index, t) {
                return `
                    <div id="work-exp-item-${index}" class="glass-card p-3 md:p-4 rounded-lg relative">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-indigo-400 text-sm md:text-base text-start-lang">${exp.title || t.workTitle}</h4>
                            <button onclick="moraCVX.removeItem('experience', ${index})" class="text-red-500 hover:text-red-700 transition p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div class="form-grid">
                            ${renderInput(t.workTitle, `workTitle-${index}`, exp.title || '', 'text')}
                            ${renderInput(t.workCompany, `workCompany-${index}`, exp.company || '', 'text')}
                        </div>
                        <div class="form-grid">
                            ${renderInput(t.workStart, `workStart-${index}`, exp.start || '', 'text')}
                            ${renderInput(t.workEnd, `workEnd-${index}`, exp.end || '', 'text', t.currentlyWork)}
                        </div>
                        <label for="workDesc-${index}" class="block text-gray-400 mb-1 text-sm md:text-base text-start-lang">${t.workDesc}</label>
                        <textarea id="workDesc-${index}" class="w-full p-2 md:p-3 rounded-lg bg-slate-800 border border-slate-700 text-white text-sm focus:ring-indigo-500 focus:border-indigo-500" rows="3">${exp.description || ''}</textarea>
                    </div>
                `;
            }

            function renderEducationItem(edu, index, t) {
                return `
                    <div id="edu-item-${index}" class="glass-card p-3 md:p-4 rounded-lg relative">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-indigo-400 text-sm md:text-base text-start-lang">${edu.degree || t.educationDegree}</h4>
                            <button onclick="moraCVX.removeItem('education', ${index})" class="text-red-500 hover:text-red-700 transition p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div class="form-grid">
                            ${renderInput(t.educationDegree, `eduDegree-${index}`, edu.degree || '', 'text')}
                            ${renderInput(t.educationInstitution, `eduInstitution-${index}`, edu.institution || '', 'text')}
                            ${renderInput(t.educationGradDate, `eduDate-${index}`, edu.date || '', 'text')}
                        </div>
                    </div>
                `;
            }

            function renderSkillItem(skill, index, t) {
                return `
                    <div id="skill-item-${index}" class="flex flex-col sm:flex-row items-start sm:items-center gap-2 glass-card p-2 md:p-3 rounded-lg">
                        <input type="text" id="skillName-${index}" value="${skill.name || ''}" placeholder="${t.skillName}" class="flex-grow p-2 rounded-lg bg-slate-800 border border-slate-700 text-white text-sm">
                        <input type="text" id="skillLevel-${index}" value="${skill.level || ''}" placeholder="${t.skillLevel}" class="w-full sm:w-2/5 p-2 rounded-lg bg-slate-800 border border-slate-700 text-white text-sm">
                        <button onclick="moraCVX.removeItem('skills', ${index})" class="text-red-500 hover:text-red-700 transition self-start sm:self-center p-1 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                `;
            }

            function renderLanguageItem(lang, index, t) {
                return `
                    <div id="lang-item-${index}" class="flex flex-col sm:flex-row items-start sm:items-center gap-2 glass-card p-2 md:p-3 rounded-lg">
                        <input type="text" id="langName-${index}" value="${lang.name || ''}" placeholder="${t.language}" class="flex-grow p-2 rounded-lg bg-slate-800 border border-slate-700 text-white text-sm">
                        <input type="text" id="langLevel-${index}" value="${lang.level || ''}" placeholder="${t.level}" class="w-full sm:w-2/5 p-2 rounded-lg bg-slate-800 border border-slate-700 text-white text-sm">
                        <button onclick="moraCVX.removeItem('languages', ${index})" class="text-red-500 hover:text-red-700 transition self-start sm:self-center p-1 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                `;
            }

            function renderCourseItem(course, index, t) {
                return `
                    <div id="course-item-${index}" class="glass-card p-3 md:p-4 rounded-lg relative">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-indigo-400 text-sm md:text-base text-start-lang">${course.name || t.courseName}</h4>
                            <button onclick="moraCVX.removeItem('courses', ${index})" class="text-red-500 hover:text-red-700 transition p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div class="form-grid">
                            ${renderInput(t.courseName, `courseName-${index}`, course.name || '', 'text')}
                            ${renderInput(t.courseProvider, `courseProvider-${index}`, course.provider || '', 'text')}
                            ${renderInput(t.courseDate, `courseDate-${index}`, course.date || '', 'text')}
                        </div>
                    </div>
                `;
            }

            function renderContactPage() {
                const t = T[state.lang];
                const contacts = [
                    { name: 'Facebook', link: 'https://www.facebook.com/share/1CDtFCSPVD/', icon: `<path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>` },
                    { name: 'Instagram', link: 'https://www.instagram.com/eltopamr55?igsh=MWJ2MzJqaXBlZzRlaQ==', icon: `<rect width="20" height="20" x="2" y="2" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"></line>` },
                    { name: 'Telegram', link: 'https://t.me/elto47', icon: `<path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.3 8L12 14.5 7.7 10 12 6.5l4.3 3.5z"></path>` },
                    { name: 'Email', link: 'mailto:amrloutfy2006@gmail.com', icon: `<rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.83 1.83 0 0 1-2.06 0L2 7"></path>` },
                    { name: 'WhatsApp', link: 'https://wa.me/201067941806', icon: `<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>` },
                ];
                return `
                    <div class="max-w-5xl mx-auto p-3 md:p-6 animate-fade-in text-start-lang">
                        <h2 class="text-3xl md:text-4xl font-extrabold text-indigo-400 mb-6 md:mb-8 text-center">${t.contactTitle}</h2>
                        <p class="text-base md:text-lg text-gray-300 mb-6 md:mb-10 text-center px-2">${t.contactIntro}</p>
                        <div class="contact-grid">
                            ${contacts.map(contact => `
                                <a href="#" data-link="${contact.link}" data-name="${contact.name}" onclick="moraCVX.showRedirectTimer(event)" class="glass-card p-4 md:p-5 rounded-xl flex flex-col items-center justify-center gap-2 hover:bg-white/10 transition-all duration-300 contact-icon-pulse text-center">
                                    <svg class="w-6 h-6 md:w-8 md:h-8 text-indigo-400 dev-text-3d" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        ${contact.icon}
                                    </svg>
                                    <div class="mt-1">
                                        <h3 class="font-bold text-sm md:text-base">${contact.name}</h3>
                                        <p class="text-xs text-gray-400">(${state.lang === 'ar' ? 'انقر للتحويل' : 'Click to redirect'})</p>
                                    </div>
                                </a>
                            `).join('')}
                        </div>
                        <p class="mt-8 text-sm text-gray-500 text-center">${t.developedBy}</p>
                    </div>
                `;
            }

            function renderPolicyPage() {
                const t = T[state.lang];
                return `
                    <div class="max-w-4xl mx-auto p-3 md:p-6 animate-fade-in text-start-lang">
                        <h2 class="text-3xl md:text-4xl font-extrabold text-indigo-400 mb-6 md:mb-8">${t.policyTitle}</h2>
                        <div class="glass-card p-4 md:p-8 rounded-xl md:rounded-2xl text-gray-300 leading-relaxed text-sm md:text-base">
                            ${t.policyContent}
                        </div>
                    </div>
                `;
            }

            function renderCVPreview() {
                const t = T[state.lang];
                const data = state.cvData;
                const p = data.personal;
                const sortedExperience = [...data.experience].sort((a, b) => new Date(b.start) - new Date(a.start));
                const cvContent = `
                    <div id="cv-content-ats" class="p-4 md:p-6 bg-white text-gray-800 shadow-xl rounded-lg relative print:shadow-none" style="width: 210mm; min-height: 297mm; direction: ${state.lang === 'ar' ? 'rtl' : 'ltr'}; font-family: 'Inter', sans-serif;">
                        <div class="mb-4 pb-2 border-b-2 border-gray-600 cv-ats-section text-${state.lang === 'ar' ? 'right' : 'left'}">
                            <h1 class="text-2xl md:text-3xl font-bold mb-1">${p.fullName || t.fullName}</h1>
                            <h2 class="text-lg md:text-xl text-gray-600 mb-2">${p.jobTitle || t.jobTitle}</h2>
                            <div class="text-sm text-gray-700 flex flex-wrap gap-x-3 ${state.lang === 'ar' ? 'justify-end' : 'justify-start'}">
                                ${p.city ? `<span><strong class="font-semibold">${p.city}</strong></span>` : ''}
                                ${(p.city && (p.phone || p.email || p.linkedin)) ? '<span>|</span>' : ''}
                                ${p.phone ? `<span dir="ltr">${p.phone}</span>` : ''}
                                ${(p.phone && (p.email || p.linkedin)) ? '<span>|</span>' : ''}
                                ${p.email ? `<span dir="ltr">${p.email}</span>` : ''}
                                ${(p.email && p.linkedin) ? '<span>|</span>' : ''}
                                ${p.linkedin ? `<span>LinkedIn: ${p.linkedin}</span>` : ''}
                            </div>
                            ${p.photo ? `<img src="${p.photo}" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-full absolute top-4 md:top-6 ${state.lang === 'ar' ? 'left-4 md:left-6' : 'right-4 md:right-6'}" alt="Photo">` : ''}
                        </div>
                        ${data.summary ? `
                        <div class="cv-ats-section mb-4 md:mb-6" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                            <h3 class="text-base md:text-lg font-bold uppercase mb-2 pb-1 border-b border-gray-400">${t.sectionSummary}</h3>
                            <p class="text-sm md:text-base leading-relaxed whitespace-pre-wrap">${data.summary}</p>
                        </div>
                        ` : ''}
                        ${data.experience.length > 0 ? `
                            <div class="cv-ats-section mb-4 md:mb-6" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                                <h3 class="text-base md:text-lg font-bold uppercase mb-3 pb-1 border-b border-gray-400">${t.sectionWork}</h3>
                                ${sortedExperience.map(exp => `
                                    <div class="mb-3">
                                        <div class="flex justify-between items-start text-sm md:text-base">
                                            <h4 class="font-bold">${exp.title || ''}${exp.company ? ` ${state.lang === 'ar' ? 'في' : 'at'} ${exp.company}` : ''}</h4>
                                            <span class="text-gray-600">${exp.start || ''} – ${exp.end || t.currentlyWork}</span>
                                        </div>
                                        ${exp.description ? `<ul class="list-disc ${state.lang === 'ar' ? 'pr-4 md:pr-5' : 'pl-4 md:pl-5'} text-sm mt-1 space-y-0.5">
                                            ${exp.description.split('\\n').filter(line => line.trim()).map(line => `<li>${line.trim()}</li>`).join('')}
                                        </ul>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${data.education.length > 0 ? `
                            <div class="cv-ats-section mb-4 md:mb-6" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                                <h3 class="text-base md:text-lg font-bold uppercase mb-3 pb-1 border-b border-gray-400">${t.sectionEducation}</h3>
                                ${data.education.map(edu => `
                                    <div class="flex justify-between items-start text-sm md:text-base mb-2">
                                        <h4 class="font-bold">${edu.degree || ''}</h4>
                                        <span class="text-gray-600">${edu.institution || ''} (${edu.date || ''})</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${data.skills.length > 0 ? `
                            <div class="cv-ats-section mb-4 md:mb-6" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                                <h3 class="text-base md:text-lg font-bold uppercase mb-3 pb-1 border-b border-gray-400">${t.sectionSkills}</h3>
                                <div class="flex flex-wrap gap-1 md:gap-2 text-xs md:text-sm">
                                    ${data.skills.map(skill => `
                                        <span class="bg-gray-100 px-2 py-1 md:px-3 md:py-1 rounded-full text-gray-700 border border-gray-300 whitespace-nowrap">${skill.name} (${skill.level})</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        <div class="flex flex-col md:flex-row ${state.lang === 'ar' ? 'gap-6 md:space-x-8 md:space-x-reverse' : 'gap-6 md:space-x-8'}">
                            ${data.languages.length > 0 ? `
                                <div class="w-full md:w-1/2 cv-ats-section">
                                    <h3 class="text-base md:text-lg font-bold uppercase mb-3 pb-1 border-b border-gray-400">${t.sectionLanguages}</h3>
                                    <ul class="text-sm space-y-0.5" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                                        ${data.languages.map(lang => `<li>${lang.name}: ${lang.level}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${data.courses.length > 0 ? `
                                <div class="w-full md:w-1/2 cv-ats-section">
                                    <h3 class="text-base md:text-lg font-bold uppercase mb-3 pb-1 border-b border-gray-400">${t.sectionCourses}</h3>
                                    <ul class="text-sm space-y-0.5" style="text-align: ${state.lang === 'ar' ? 'right' : 'left'};">
                                        ${data.courses.map(course => `<li>${course.name} (${course.provider}, ${course.date})</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                return `
                    <div class="max-w-7xl mx-auto p-2 md:p-4 lg:p-6 animate-fade-in">
                        <h2 class="text-3xl md:text-4xl font-extrabold text-indigo-400 mb-6 md:mb-8 text-center">${t.wizardSteps[state.maxWizardStep - 1]}</h2>
                        <div class="flex flex-col sm:flex-row justify-center gap-2 md:gap-4 mb-6 md:mb-8">
                            <button class="futuristic-btn bg-green-600 hover:bg-green-700 px-4 py-2 text-sm md:text-base flex-1 sm:flex-none" onclick="moraCVX.downloadPDF()">
                                ${t.downloadPDF}
                            </button>
                            <button class="futuristic-outline-btn px-4 py-2 text-sm md:text-base flex-1 sm:flex-none" onclick="moraCVX.copyCVText()">
                                ${t.copyText}
                            </button>
                            <button class="futuristic-outline-btn px-4 py-2 text-sm md:text-base flex-1 sm:flex-none" onclick="moraCVX.changeView('wizard', null, ${state.maxWizardStep})">
                                ${t.backToEdit}
                            </button>
                        </div>
                        <div id="cv-preview-container" class="flex justify-center p-2 md:p-4 bg-gray-900 rounded-xl overflow-auto">
                            ${cvContent}
                        </div>
                    </div>
                `;
            }

            function attachWizardEvents() {
                const contentDiv = document.getElementById('wizard-content');
                const backBtn = document.getElementById('back-btn');
                const nextBtn = document.getElementById('next-btn');
                const finishBtn = document.getElementById('finish-btn');
                if (backBtn) backBtn.addEventListener('click', () => changeWizardStep(-1));
                if (nextBtn) nextBtn.addEventListener('click', () => {
                    if (validateStep(state.cvWizardStep)) {
                        changeWizardStep(1);
                    }
                });
                if (finishBtn) finishBtn.addEventListener('click', () => {
                    if (validateStep(state.cvWizardStep)) {
                        changeView('preview');
                    }
                });
                const photoUpload = document.getElementById('photo-upload');
                if (photoUpload) {
                    photoUpload.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (ev) => {
                                state.cvData.personal.photo = ev.target.result;
                                saveCVDataToFirestore();
                                renderView();
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
                if (state.cvWizardStep === 3) {
                    document.getElementById('add-work-exp-btn')?.addEventListener('click', () => addItem('experience', { title: '', company: '', start: '', end: '', description: '' }));
                }
                if (state.cvWizardStep === 4) {
                    document.getElementById('add-education-btn')?.addEventListener('click', () => addItem('education', { degree: '', institution: '', date: '' }));
                }
                if (state.cvWizardStep === 5) {
                    document.getElementById('add-skill-btn')?.addEventListener('click', () => addItem('skills', { name: '', level: '' }));
                }
                if (state.cvWizardStep === 6) {
                    document.getElementById('add-language-btn')?.addEventListener('click', () => addItem('languages', { name: '', level: '' }));
                    document.getElementById('add-course-btn')?.addEventListener('click', () => addItem('courses', { name: '', provider: '', date: '' }));
                }
                contentDiv?.querySelectorAll('input, textarea').forEach(input => {
                    input.addEventListener('blur', updateCVData);
                });
            }

            function updateCVData() {
                const step = state.cvWizardStep;
                const data = state.cvData;
                switch (step) {
                    case 1:
                        data.personal.fullName = document.getElementById('fullName')?.value || '';
                        data.personal.jobTitle = document.getElementById('jobTitle')?.value || '';
                        data.personal.phone = document.getElementById('phone')?.value || '';
                        data.personal.email = document.getElementById('email')?.value || '';
                        data.personal.city = document.getElementById('city')?.value || '';
                        data.personal.linkedin = document.getElementById('linkedin')?.value || '';
                        break;
                    case 2:
                        data.summary = document.getElementById('summary')?.value || '';
                        break;
                    case 3:
                        data.experience = data.experience.map((exp, index) => ({
                            title: document.getElementById(`workTitle-${index}`)?.value || '',
                            company: document.getElementById(`workCompany-${index}`)?.value || '',
                            start: document.getElementById(`workStart-${index}`)?.value || '',
                            end: document.getElementById(`workEnd-${index}`)?.value || '',
                            description: document.getElementById(`workDesc-${index}`)?.value || '',
                        })).filter(exp => exp.title || exp.company);
                        break;
                    case 4:
                        data.education = data.education.map((edu, index) => ({
                            degree: document.getElementById(`eduDegree-${index}`)?.value || '',
                            institution: document.getElementById(`eduInstitution-${index}`)?.value || '',
                            date: document.getElementById(`eduDate-${index}`)?.value || '',
                        })).filter(edu => edu.degree || edu.institution);
                        break;
                    case 5:
                        data.skills = data.skills.map((skill, index) => ({
                            name: document.getElementById(`skillName-${index}`)?.value || '',
                            level: document.getElementById(`skillLevel-${index}`)?.value || '',
                        })).filter(skill => skill.name);
                        break;
                    case 6:
                        data.languages = data.languages.map((lang, index) => ({
                            name: document.getElementById(`langName-${index}`)?.value || '',
                            level: document.getElementById(`langLevel-${index}`)?.value || '',
                        })).filter(lang => lang.name);
                        data.courses = data.courses.map((course, index) => ({
                            name: document.getElementById(`courseName-${index}`)?.value || '',
                            provider: document.getElementById(`courseProvider-${index}`)?.value || '',
                            date: document.getElementById(`courseDate-${index}`)?.value || '',
                        })).filter(course => course.name);
                        break;
                }
                saveCVDataToFirestore();
            }

            function changeWizardStep(delta) {
                updateCVData();
                let newStep = state.cvWizardStep + delta;
                if (newStep >= 1 && newStep <= state.maxWizardStep) {
                    state.cvWizardStep = newStep;
                    const content = document.getElementById('wizard-content');
                    if (content) {
                        content.classList.remove('animate-fade-in');
                        content.classList.add('opacity-0');
                        setTimeout(() => {
                            renderView();
                            const newContent = document.getElementById('wizard-content');
                            if (newContent) {
                                newContent.classList.remove('opacity-0');
                                newContent.classList.add('animate-fade-in');
                            }
                        }, 250);
                    } else {
                        renderView();
                    }
                }
            }

            function addItem(section, defaultItem) {
                state.cvData[section].push(defaultItem);
                renderView();
            }

            function removeItem(section, index) {
                state.cvData[section].splice(index, 1);
                saveCVDataToFirestore();
                renderView();
            }

            function downloadPDF() {
                const element = document.getElementById('cv-content-ats');
                const t = T[state.lang];
                if (!element) return;
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: (state.cvData.personal.fullName || 'CV') + '_Mora-CVX.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: false, useCORS: true, scrollY: -window.scrollY },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                html2pdf().from(element).set(opt).save().catch(err => {
                    console.error("PDF error:", err);
                    alert(state.lang === 'ar' ? 'فشل توليد ملف PDF. يرجى المحاولة مرة أخرى.' : 'PDF generation failed. Please try again.');
                });
            }

            function copyCVText() {
                const element = document.getElementById('cv-content-ats');
                if (!element) return;
                const textContent = element.innerText;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textContent).then(() => {
                        showNotification(state.lang === 'ar' ? 'تم نسخ نص السيرة الذاتية بنجاح!' : 'CV text copied successfully!');
                    }).catch(err => fallbackCopyTextToClipboard(textContent));
                } else {
                    fallbackCopyTextToClipboard(textContent);
                }
            }

            function fallbackCopyTextToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    const ok = document.execCommand('copy');
                    showNotification(ok ? (state.lang === 'ar' ? 'تم النسخ!' : 'Copied!') : (state.lang === 'ar' ? 'فشل النسخ.' : 'Copy failed.'));
                } catch (err) {
                    showNotification(state.lang === 'ar' ? 'فشل النسخ (يرجى المحاولة يدويًا).' : 'Copy failed (please try manually).', 'error');
                } finally {
                    document.body.removeChild(textarea);
                }
            }

            function showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 ${state.lang === 'ar' ? 'left-4' : 'right-4'} p-3 md:p-4 rounded-lg shadow-xl text-white z-50 transition-opacity duration-300 animate-fade-in max-w-xs md:max-w-md text-sm md:text-base`;
                notification.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            function showRedirectTimer(event) {
                event.preventDefault();
                const target = event.currentTarget;
                const url = target.getAttribute('data-link');
                const name = target.getAttribute('data-name');
                const t = T[state.lang];
                if (!url) return;
                elements.redirectMessage.textContent = `${t.redirecting} ${name}`;
                elements.redirectOverlay.classList.remove('hidden', 'opacity-0');
                elements.redirectOverlay.classList.add('opacity-100');
                let count = 3;
                elements.redirectTimer.textContent = count;
                const timer = setInterval(() => {
                    count -= 1;
                    elements.redirectTimer.textContent = count;
                    if (count <= 0) {
                        clearInterval(timer);
                        window.open(url, '_blank');
                        elements.redirectOverlay.classList.add('opacity-0');
                        setTimeout(() => elements.redirectOverlay.classList.add('hidden'), 300);
                    }
                }, 1000);
            }

            function changeLanguage(lang) {
                state.lang = lang;
                localStorage.setItem(STORAGE_KEY_LANG, lang);
                renderView();
            }

            function changeView(view, event = null, step = 1) {
                if (event) event.preventDefault();
                if (state.view === 'langSelect') {
                    destroyThreeJS();
                }
                state.view = view;
                if (view === 'wizard') state.cvWizardStep = step;
                renderView();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function toggleMobileMenu(show) {
                if (show === undefined) show = elements.mobileMenuOverlay.classList.contains('hidden');
                if (show) {
                    elements.mobileMenuOverlay.classList.remove('hidden');
                    setTimeout(() => elements.mobileMenuOverlay.classList.remove('opacity-0'), 10);
                    // ✅ إغلاق القائمة عند الضغط خارجها
                    document.addEventListener('click', closeMenuOnOutsideClick);
                } else {
                    elements.mobileMenuOverlay.classList.add('opacity-0');
                    setTimeout(() => {
                        elements.mobileMenuOverlay.classList.add('hidden');
                        document.removeEventListener('click', closeMenuOnOutsideClick);
                    }, 300);
                }
            }

            function closeMenuOnOutsideClick(e) {
                if (!elements.mobileMenuOverlay.contains(e.target) && e.target !== elements.mobileMenuBtn) {
                    toggleMobileMenu(false);
                }
            }

            function showSplash() {
                const splashShown = localStorage.getItem(STORAGE_KEY_SPLASH);
                if (splashShown) {
                    elements.splashScreen.classList.add('hidden');
                    state.view = 'langSelect';
                    renderView();
                    return;
                }
                setTimeout(() => {
                    elements.devCredit.classList.add('dev-credit-anim');
                    elements.devCredit.style.opacity = '1';
                }, 1500);
                setTimeout(() => elements.splashScreen.classList.remove('opacity-100'), 3000);
                setTimeout(() => {
                    elements.splashScreen.classList.add('hidden');
                    localStorage.setItem(STORAGE_KEY_SPLASH, 'true');
                    state.view = 'langSelect';
                    renderView();
                }, 3500);
            }

            function init() {
                window.initializeFirebase();
                elements.mobileMenuBtn.addEventListener('click', () => toggleMobileMenu(true));
                elements.closeMobileMenu.addEventListener('click', () => toggleMobileMenu(false));
                showSplash();
            }

            return {
                init,
                changeLanguage,
                changeView,
                changeWizardStep,
                updateCVData,
                addItem,
                removeItem,
                downloadPDF,
                copyCVText,
                toggleMobileMenu,
                setFirebaseReady,
                showRedirectTimer,
                state: () => state
            };
        })();

        window.moraCVX = moraCVX;
        document.addEventListener('DOMContentLoaded', moraCVX.init);
    </script>
</body>
</html>
